<!DOCTYPE html><html lang="fr"><head><title data-react-helmet="true">Comment on a fait ce site | Putain de code</title><meta data-react-helmet="true" charset="UTF-8"/><meta data-react-helmet="true" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" name="viewport"/><meta data-react-helmet="true" content="summary_large_image" name="twitter:card"/><meta data-react-helmet="true" content="Putain de code !" property="og:site_name"/><meta data-react-helmet="true" content="@putaindecode" name="twitter:site"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" property="og:image"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" name="twitter:image"/><meta data-react-helmet="true" content="1500" property="og:image:width"/><meta data-react-helmet="true" content="777" property="og:image:height"/><meta data-react-helmet="true" content="Comment on a fait ce site | Putain de code" property="og:title"/><meta data-react-helmet="true" content="Comment on a fait ce site | Putain de code" name="twitter:title"/><meta data-react-helmet="true" content="Un article proposé par bloodyowl" name="description"/><link data-react-helmet="true" title="RSS Feed" href="/api/articles/feeds/desc/feed.xml" rel="alternate" type="application/rss+xml"/><link data-react-helmet="true" href="/favicon.ico" rel="shortcut icon"/><link data-react-helmet="true" href="https://putaindecode.io/articles/comment-on-a-fait-ce-site" rel="canonical"/><script>window.PAGES_BOOT_MODE="hydrate";</script></head><div id="root"><style data-emotion="rpcss zx73cm 1lc6tyj 28v1b4">@-webkit-keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}@keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}:root{--page-background-color:#fff;--page-slightly-accented-background-color:#F9F6F6;--page-accented-background-color:#E4EBEE;--page-text-color:#46515B;--link-text-color:#E51D58;--gradient-red-top:#E51D58;--gradient-red-bottom:#CC0613;--code-background-color:#FAF3E1;--one-percent-contrast-color:rgba(0, 0, 0, 0.1);--half-percent-contrast-color:rgba(0, 0, 0, 0.05);}@media (prefers-color-scheme: dark){:root{--page-background-color:#222;--page-slightly-accented-background-color:#171717;--page-accented-background-color:#111;--page-text-color:#ddd;--link-text-color:#F87098;--gradient-red-top:#E51D58;--gradient-red-bottom:#CC0613;--code-background-color:#4F3804;--one-percent-contrast-color:rgba(255, 255, 255, 0.1);--half-percent-contrast-color:rgba(255, 255, 255, 0.05);}}body{padding:0;margin:0;background-color:var(--page-background-color);color:var(--page-text-color);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;overflow-x:hidden;}html{font-size:1em;line-height:1.4;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;}a{color:var(--link-text-color);-webkit-text-decoration:underline;text-decoration:underline;}a:hover{-webkit-text-decoration:none;text-decoration:none;}#root{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}*,*:before,*:after{box-sizing:border-box;}pre,.hljs{color:#adbac7;background:#22272e;}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#f47067;}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#dcbdfb;}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-variable,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id{color:#6cb6ff;}.hljs-regexp,.hljs-string,.hljs-meta .hljs-string{color:#96d0ff;}.hljs-built_in,.hljs-symbol{color:#f69d50;}.hljs-comment,.hljs-code,.hljs-formula{color:#768390;}.hljs-name,.hljs-quote,.hljs-selector-tag,.hljs-selector-pseudo{color:#8ddb8c;}.hljs-subst{color:#adbac7;}.hljs-section{color:#316dca;font-weight:bold;}.hljs-bullet{color:#eac55f;}.hljs-emphasis{color:#adbac7;font-style:italic;}.hljs-strong{color:#adbac7;font-weight:bold;}.hljs-addition{color:#b4f1b4;background-color:#1b4721;}.hljs-deletion{color:#ffd8d3;background-color:#78191b;}</style><style data-emotion="rpcss 9vhaby">.rpcss-9vhaby{background-color:var(--gradient-red-bottom);background-image:linear-gradient(to bottom right, var(--gradient-red-top), var(--gradient-red-bottom));}</style><header class="rpcss-9vhaby" style="background-image:linear-gradient(to bottom right, hsl(227, 100%, 35%), hsl(188, 100%, 30%))"><style data-emotion="rpcss 1qqk0tr">.rpcss-1qqk0tr{padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);}</style><div class="rpcss-1qqk0tr"><style data-emotion="rpcss qx7dny">.rpcss-qx7dny{width:100%;max-width:1024px;margin:0 auto;padding:0 10px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="rpcss-qx7dny"><style data-emotion="rpcss 7s9om2">.rpcss-7s9om2{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding:20px 0 50px;}</style><div class="rpcss-7s9om2"><style data-emotion="rpcss gdpa5c">.rpcss-gdpa5c{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-gdpa5c" href="/"><style data-emotion="rpcss 1lm4738">.rpcss-1lm4738{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;padding-bottom:10px;}</style><div class="rpcss-1lm4738"><style data-emotion="rpcss 13o7eu2">.rpcss-13o7eu2{display:block;}</style><svg class="rpcss-13o7eu2" height="36px" width="36px" viewBox="0 0 36 36"><defs><linearGradient id="PutainDeCodeLogoGradient" x1="50%" x2="50%" y1="0%" y2="127.223881%"><stop offset="0%" stop-color="#E41D57"></stop><stop offset="100%" stop-color="#C60000"></stop></linearGradient></defs><circle cx="18" cy="18" fill="url(#PutainDeCodeLogoGradient)" r="17" stroke="#FFFFFF" stroke-width="2"></circle><polygon fill="#FFFFFF" points="15.9033203 18.2246094 15.9033203 18.3710938 11.2304688 20.5317383 11.2304688 22.8095703 18.0566406 19.184082 18.0566406 17.4116211 11.2304688 13.7788086 11.2304688 16.0639648"></polygon><rect height="14" width="2" fill="#FFFFFF" x="22" y="11"><animate attributeName="opacity" begin="100ms" calcMode="discrete" dur="2s" repeatCount="indefinite" values="1;0"></animate></rect></svg><style data-emotion="rpcss 4cf197">.rpcss-4cf197{width:10px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-4cf197"></div><style data-emotion="rpcss u5k24">.rpcss-u5k24{font-size:22px;color:#fff;font-weight:800;}</style><div aria-level="2" class="rpcss-u5k24" role="heading">Putain de code !</div></div><style data-emotion="rpcss 1nyebg4">.rpcss-1nyebg4{font-size:14px;color:rgba(255, 255, 255, 0.8);text-align:center;}</style><div class="rpcss-1nyebg4">Blog participatif de la communauté dev</div></a></div></div></div></header><style data-emotion="rpcss a4ric9">.rpcss-a4ric9{background-color:var(--page-slightly-accented-background-color);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="rpcss-a4ric9"><style data-emotion="rpcss oeugsb">.rpcss-oeugsb{-webkit-animation:500ms ease-out animation-zx73cm;animation:500ms ease-out animation-zx73cm;}</style><div class="rpcss-oeugsb"><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 1qc2bam">.rpcss-1qc2bam{font-size:42px;font-weight:800;text-align:center;padding-top:40px;line-height:1.2;margin:0;}</style><h1 class="rpcss-1qc2bam">Comment on a fait ce site</h1><style data-emotion="rpcss obg2kr">.rpcss-obg2kr{font-size:16px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding-top:10px;padding-bottom:40px;color:var(--page-text-color);-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-obg2kr" href="https://github.com/bloodyowl"><style data-emotion="rpcss uco8i7">.rpcss-uco8i7{width:32px;height:32px;border-radius:100%;margin-right:10px;}</style><img class="rpcss-uco8i7" alt="bloodyowl" src="https://avatars.githubusercontent.com/bloodyowl?size=64"/><div>bloodyowl<!-- --> <!-- -->•<!-- --> <!-- -->2019/03/18</div></a><style data-emotion="rpcss 15kxmi0">.rpcss-15kxmi0{max-width:640px;width:100%;font-size:18px;margin:0 auto;line-height:1.7;}.rpcss-15kxmi0 h2,.rpcss-15kxmi0 h3,.rpcss-15kxmi0 h4,.rpcss-15kxmi0 h5,.rpcss-15kxmi0 h6{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;font-weight:800;line-height:1.2;}.rpcss-15kxmi0 img{max-width:100%;background-color:rgba(255, 255, 255, 0.75);}.rpcss-15kxmi0 code{font-size:0.9em;font-family:PragmataPro,SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;line-height:1;background-color:var(--code-background-color);margin:0 0.2em;}.rpcss-15kxmi0 pre{padding:10px;overflow-x:auto;font-size:14px;border-radius:10px;border:2px solid var(--one-percent-contrast-color);-webkit-overflow-scrolling:touch;}.rpcss-15kxmi0 pre code{font-size:14px;background-color:transparent;margin:0;}.rpcss-15kxmi0 blockquote{padding-left:20px;margin:0;font-size:16px;border-left:3px solid var(--one-percent-contrast-color);font-style:italic;}.rpcss-15kxmi0 table{width:100%;text-align:center;}.rpcss-15kxmi0 figure{padding:20px 0;}.rpcss-15kxmi0 figcaption{text-align:center;}.rpcss-15kxmi0 a{word-wrap:break-word;}.rpcss-15kxmi0 table thead th{background-color:var(--page-accented-background-color);padding:10px 0;}</style><div class="rpcss-15kxmi0"><p>Puisqu'on vient de sortir une refonte du site, c'est l'occasion de faire un tour sur le processus qui nous y a amené.</p>
<h2>tl;dr;</h2>
<p><img src="/public/images/articles/2019-03-18-comment-on-a-fait-ce-site/serious-graph.svg" alt="On prend des markdown et des fichiers Reason et on génère des HTML, des JS, des JSON mais pas de CSS" /></p>
<h2>Un nouveau site</h2>
<p>Avant ça, le site n'avait pas énormément évolué depuis quelques années. On a commencé à parler d'un redesign complet du site il y a un an et demi, on a maquetté la chose (c'est le design que vous voyez maintenant), mais on n'a rien foutu par manque de temps et par flemme de s'attaquer à un pareil chantier.</p>
<p>On s'est quand même finalement décidé à retaper le site en un weekend, parce qu'on emmerde les proverbes sur les cordonniers.</p>
<p>Alors comment on a fait ?</p>
<h2>Revoir les besoins</h2>
<p>Comme tout projet, on accumule au gré des années. On avait à l'époque un script JS qui <strong>parsait l'historique Git</strong> et tapait l'API GitHub pour fournir des données qui se sont avérées être <strong>trop granulaires</strong> pour nos besoins (et qui foirait une fois sur deux dès qu'une nouvelle personne voulait contribuer au projet).</p>
<p>On ajoutait des petites features trop tôt, dès qu'une demande apparaissait dans les issues. Et ces features nous bloquaient pour en produire de nouvelles qui avaient plus d'intérêt pour la vie de l'organisation et du blog (notamment au vu des podcasts arrivés depuis 2016).</p>
<p>En prenant un peu de recul, on a réalisé que nos besoin se résumaient à trois points importants :</p>
<ul>
<li>une <strong>home</strong></li>
<li>une zone <strong>articles</strong></li>
<li>une zone <strong>podcasts</strong></li>
</ul>
<h2>Tout refaire sans déglinguer l'historique git</h2>
<p>Quand on s'est lancé dans l'ouvrage de refaire le site, il y avait un impératif : <strong>préserver les contributions</strong> de nos auteurs.</p>
<p>D'un autre côté, partir d'un repository existant peut énormément limiter la création (alors que partir d'un projet tout frais tout neuf ça motive). On a du coup choisi une approche alternative: copier le projet, l'altérer à foison, et coller le résultat dans une énorme PR.</p>
<p>Partir d'un <code>package.json</code> vierge était essentiel. On avait <strong>beaucoup</strong> trop de trucs.</p>
<h2>Les technos</h2>
<p>On a choisir de partir sur <a href="/articles/introduction-a-reasonml">ReasonML</a>, parce que c'est une technologie dans laquelle on croit, que dans l'équipe on est tous familiers avec <a href="/articles/reason-react-pour-une-ui-qu-elle-est-bien-typee">React</a> et parce qu'avec son <em>type system</em>, elle nous apporte des avantages non négligeables sur un projet pouvant être édité par un grand nombre de personnes: c'est une sorte de garde-fou.</p>
<p>Pour le styling, si vous me suivez depuis longtemps, vous savez que <a href="/articles/pourquoi-j-ai-arrete-d-utiliser-css">j'adore CSS</a>, je suis donc parti sur <a href="https://github.com/SentiaAnalytics/bs-css/"><code>bs-css</code></a>, un DSL statiquement typé qui utilise <a href="https://emotion.sh">emotion</a>, ce qui nous permet d'envoyer au client <strong>uniquement les styles requis</strong>.</p>
<h2>L'approche technique: une static SPA</h2>
<p>La question qu'on s'est posée : quel est <strong>le moyen le plus efficace de livrer une page de blog</strong> aux lecteurs ?</p>
<p>Et la réponse qui s'est imposée à nous était dans la veine de ce qu'on avait déjà fait par le passé : une <strong>SPA statique</strong>.</p>
<p>Qu'est-ce qu'une SPA statique ? C'est un site statique <strong>conçu comme une single page application</strong>. On conçoit le site comme une application React côté client, et on va pré-rendre les pages non pas côté serveur, mais dans notre système d'intégration continue.</p>
<p>Pourquoi de <strong>l'hébergement statique</strong> ? Parce que c'est moins cher (voire gratuit), qu'on est principalement front et que la dernière fois que je me suis connecté à la console AWS j'y suis resté coincé pendant 5 jours.</p>
<p>Ce que ça apporte : un <strong>chargement initial extrêmement rapide</strong>, une <strong>navigation optimale</strong> et des <strong>besoins en serveur réduits au minimum</strong>.</p>
<p>Quand un lecteur arrive sur le site, il récupère une version de la page <strong>déjà rendue</strong> au moment du build, le client ne fait que &quot;hydrater&quot; la page. Lors que le lecteur navigue vers une autre page, le client va <strong>uniquement chercher la donnée dont il a besoin</strong> pour la page de destination.</p>
<p>En développement local, chaque page démarre avec un <strong>data-store vide</strong>, et les composants vont <strong>demander le chargement des données</strong>. En production, chaque page est livrée <strong>rendue</strong>, avec le data-store <strong>contenant les informations dont elle a besoin</strong>, toute navigation ultérieure sera comme en mode local: les composants vont demander le chargement de ce qui leur manque.</p>
<p>Ce mode de fonctionnement requiert une certaine discipline concernant les endroits où la donnée peut être stockée. Dans notre cas, on a choisi de la placer dans l'état du composant qui orchestre l'application, et de le faire sous la forme suivante:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">type</span> state = {
  articles: <span class="hljs-module-identifier">Map</span>.<span class="hljs-module-identifier">String</span>.t(<span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Post</span>.t, <span class="hljs-module-identifier">Errors</span>.t))),
  articleList: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(array(<span class="hljs-module-identifier">PostShallow</span>.t), <span class="hljs-module-identifier">Errors</span>.t)),
  podcasts: <span class="hljs-module-identifier">Map</span>.<span class="hljs-module-identifier">String</span>.t(<span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Podcast</span>.t, <span class="hljs-module-identifier">Errors</span>.t))),
  podcastList: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(array(<span class="hljs-module-identifier">PodcastShallow</span>.t), <span class="hljs-module-identifier">Errors</span>.t)),
  home: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Home</span>.t, <span class="hljs-module-identifier">Errors</span>.t)),
};
</code></pre>
<p>Cet état peut stocker <strong>l'intégralité des données du blog</strong>, comme il peut stocker le <strong>minimum possible</strong>. Si vous voulez en savoir plus, n'hésitez pas à naviguer dans les sources du site.</p>
<p>Une approche alternative est de stocker la donnée requise par chaque URL, mais cette approche s'avère moins efficace au niveau du cache: si on a déjà toutes les données depuis une autre URL, on va quand même devoir les charger à nouveau.</p>
<h2>Coder le blog</h2>
<p>Le blog était organisé d'une manière … chaotique. L'emplacement des fichiers markdown dans le repository définissait leur URL sur le site (on devait se dire que c'était une bonne idée à l'époque). Pour plus de perennité, on a choisi de passer à un système où le nom ou l'emplacement du fichier n'avaient pas d'impact sur l'endroit où se retrouve sur le site. Ça nous permet de les organiser par date, par sujet ou par contrib dans le futur sans pour autant influer sur les URLs.</p>
<p>Avec <a href="https://twitter.com/jojmaht">jojmaht</a>, on a pris la tâche ingrate de bouger et transformer la centaine d'articles existants, avec leurs médias, vers une <strong>organisation à plat</strong>, plus simple à gérer.</p>
<p>Une fois cette tâche gérée, on n'avait plus qu'à récupérer les posts et à les générer aux URLs qui vont bien.</p>
<h2>Gérer la retro-compatibilité</h2>
<p>On a profité de ce chantier pour réécrire les URLs des articles vers des formats plus lisibles (e.g. <code>/articles/js/react</code> -&gt; <code>/articles/introduction-a-react</code>).</p>
<p>Pour preserver les anciennes URLs, on a indiqué l'ancienne URL des articles dans chaque fichier markdown, et on a généré à ces endroits là une page HTML:</p>
<pre><code class="hljs language-html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0;URL=NOUVELLE_URL&quot;</span> /&gt;</span>
</code></pre>
<p>On se sert également de cette ancienne URL comme identifiant de page pour notre système de commentaires qui tourne avec disqus parce que j'ai pas trouvé la page pour migrer les URLs sur leur admin.</p>
<p>Si vous voulez en savoir un peu plus, n'hésitez pas à parcourir <a href="https://github.com/putaindecode/putaindecode.io">la source du projet</a>. Et n'hésitez pas à <a href="https://github.com/putaindecode/putaindecode.io/blob/master/CONTRIBUTING.md">contribuer au blog</a> si l'envie vous vient.</p>
<p>Bisous.</p>
</div><style data-emotion="rpcss unyj6i">.rpcss-unyj6i{max-width:640px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;margin:20px auto;padding:20px;background-color:var(--page-background-color);border-radius:10px;box-shadow:0 15px 15px -5px rgba(0, 0, 0, 0.2);}@media (max-width: 540px){.rpcss-unyj6i{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-unyj6i"><style data-emotion="rpcss ty7r4z">.rpcss-ty7r4z{font-weight:800;}</style><div class="rpcss-ty7r4z">Vous avez aimé cet article?</div><style data-emotion="rpcss klacsp">.rpcss-klacsp{width:0;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-klacsp"></div><style data-emotion="rpcss 1pkr03v">.rpcss-1pkr03v{background-color:#00aced;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:800;}.rpcss-1pkr03v:active{opacity:0.5;}</style><a class="rpcss-1pkr03v" href="https://www.twitter.com/intent/tweet?text=Comment%20on%20a%20fait%20ce%20site%20sur%20%40PutainDeCode%20https%3A%2F%2Fputaindecode.io%2Farticles%2Fcomment-on-a-fait-ce-site" target="_blank">Le partager sur Twitter</a></div><style data-emotion="rpcss x4iqxe">.rpcss-x4iqxe{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;text-align:center;padding:20px;}</style><div class="rpcss-x4iqxe"><style data-emotion="rpcss gein6x">.rpcss-gein6x{font-size:20px;-webkit-text-decoration:none;text-decoration:none;color:#1E49B5;}</style><a class="rpcss-gein6x" href="/articles">← Articles</a></div><style data-emotion="rpcss 8bodgl">.rpcss-8bodgl{max-width:640px;width:100%;margin:0 auto;padding:20px 0;}</style><div class="rpcss-8bodgl" id="disqus_thread"></div></div></div></div></div><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 1vau6rl">.rpcss-1vau6rl{margin:20px 0;background-color:var(--page-accented-background-color);border-radius:10px;padding:20px;}</style><div class="rpcss-1vau6rl"><style data-emotion="rpcss 1gz1i1h">.rpcss-1gz1i1h{font-size:32px;font-weight:800;margin-bottom:20px;text-align:center;}</style><div aria-level="2" class="rpcss-1gz1i1h" role="heading">Ne rien rater</div><style data-emotion="rpcss 1wbispj">.rpcss-1wbispj{font-size:18px;margin-bottom:10px;text-align:center;}</style><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur les réseaux</div><style data-emotion="rpcss 1hyoz7m">.rpcss-1hyoz7m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}</style><div class="rpcss-1hyoz7m"><a href="https://twitter.com/PutainDeCode"><img alt="Twitter" height="48" src="/public/images/website/twitter.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://facebook.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/facebook.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://github.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/github.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://itunes.apple.com/fr/podcast/putain-de-code-!/id1185311825"><img alt="Apple Podcast" height="48" src="/public/images/website/apple-podcast.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://soundcloud.com/putaindecode"><img alt="Soundcloud" height="48" src="/public/images/website/soundcloud.svg" width="48"/></a></div><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur le chat</div><div class="rpcss-1hyoz7m"><a href="https://discord.gg/jtbGNNc"><img alt="Discord" height="48" src="/public/images/website/discord.svg" width="48"/></a></div></div></div></div><style data-emotion="rpcss zs8kw7">.rpcss-zs8kw7{background-color:#222;padding:20px 0;}</style><footer class="rpcss-zs8kw7"><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 79elbk">.rpcss-79elbk{position:relative;}</style><div class="rpcss-79elbk"><style data-emotion="rpcss 1hle0ni">.rpcss-1hle0ni{position:absolute;left:0;top:50%;color:#fff;-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1hle0ni" href="/api/articles/feeds/desc/feed.xml"><style data-emotion="rpcss lvyu5j">.rpcss-lvyu5j{margin-right:10px;}</style><img class="rpcss-lvyu5j" alt="Flux RSS" height="16" src="/public/images/website/rss-feed.svg" width="16"/><style data-emotion="rpcss um3i31">@media (max-width: 400px){.rpcss-um3i31{display:none;}}</style><div class="rpcss-um3i31">Flux RSS</div></a><style data-emotion="rpcss 12cp4l7">.rpcss-12cp4l7{color:rgba(255, 255, 255, 0.5);text-align:center;font-size:14px;}</style><div class="rpcss-12cp4l7">© 2021 Putain de code !</div><style data-emotion="rpcss 1w98uy3">.rpcss-1w98uy3{position:absolute;right:0;top:50%;color:#fff;-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1w98uy3" href="https://github.com/putaindecode/putaindecode.io">GitHub</a></div></div></div></footer></div><script id="initialData" type="text/data">{"lists":{"RE_PRIVATE_NONE":true},"items":{"k":"articles","v":{"k":"comment-on-a-fait-ce-site","v":{"_0":{"TAG":0,"_0":{"slug":"comment-on-a-fait-ce-site","filename":"2019-03-18-comment-on-a-fait-ce-site","title":"Comment on a fait ce site","date":"Mon, 18 Mar 2019 00:00:00 GMT","draft":false,"meta":{"date":"2019-03-18T00:00:00.000Z","title":"Comment on a fait ce site","author":"bloodyowl","slug":"comment-on-a-fait-ce-site"},"body":"<p>Puisqu'on vient de sortir une refonte du site, c'est l'occasion de faire un tour sur le processus qui nous y a amené.</p>\n<h2>tl;dr;</h2>\n<p><img src=\"/public/images/articles/2019-03-18-comment-on-a-fait-ce-site/serious-graph.svg\" alt=\"On prend des markdown et des fichiers Reason et on génère des HTML, des JS, des JSON mais pas de CSS\" /></p>\n<h2>Un nouveau site</h2>\n<p>Avant ça, le site n'avait pas énormément évolué depuis quelques années. On a commencé à parler d'un redesign complet du site il y a un an et demi, on a maquetté la chose (c'est le design que vous voyez maintenant), mais on n'a rien foutu par manque de temps et par flemme de s'attaquer à un pareil chantier.</p>\n<p>On s'est quand même finalement décidé à retaper le site en un weekend, parce qu'on emmerde les proverbes sur les cordonniers.</p>\n<p>Alors comment on a fait ?</p>\n<h2>Revoir les besoins</h2>\n<p>Comme tout projet, on accumule au gré des années. On avait à l'époque un script JS qui <strong>parsait l'historique Git</strong> et tapait l'API GitHub pour fournir des données qui se sont avérées être <strong>trop granulaires</strong> pour nos besoins (et qui foirait une fois sur deux dès qu'une nouvelle personne voulait contribuer au projet).</p>\n<p>On ajoutait des petites features trop tôt, dès qu'une demande apparaissait dans les issues. Et ces features nous bloquaient pour en produire de nouvelles qui avaient plus d'intérêt pour la vie de l'organisation et du blog (notamment au vu des podcasts arrivés depuis 2016).</p>\n<p>En prenant un peu de recul, on a réalisé que nos besoin se résumaient à trois points importants :</p>\n<ul>\n<li>une <strong>home</strong></li>\n<li>une zone <strong>articles</strong></li>\n<li>une zone <strong>podcasts</strong></li>\n</ul>\n<h2>Tout refaire sans déglinguer l'historique git</h2>\n<p>Quand on s'est lancé dans l'ouvrage de refaire le site, il y avait un impératif : <strong>préserver les contributions</strong> de nos auteurs.</p>\n<p>D'un autre côté, partir d'un repository existant peut énormément limiter la création (alors que partir d'un projet tout frais tout neuf ça motive). On a du coup choisi une approche alternative: copier le projet, l'altérer à foison, et coller le résultat dans une énorme PR.</p>\n<p>Partir d'un <code>package.json</code> vierge était essentiel. On avait <strong>beaucoup</strong> trop de trucs.</p>\n<h2>Les technos</h2>\n<p>On a choisir de partir sur <a href=\"/articles/introduction-a-reasonml\">ReasonML</a>, parce que c'est une technologie dans laquelle on croit, que dans l'équipe on est tous familiers avec <a href=\"/articles/reason-react-pour-une-ui-qu-elle-est-bien-typee\">React</a> et parce qu'avec son <em>type system</em>, elle nous apporte des avantages non négligeables sur un projet pouvant être édité par un grand nombre de personnes: c'est une sorte de garde-fou.</p>\n<p>Pour le styling, si vous me suivez depuis longtemps, vous savez que <a href=\"/articles/pourquoi-j-ai-arrete-d-utiliser-css\">j'adore CSS</a>, je suis donc parti sur <a href=\"https://github.com/SentiaAnalytics/bs-css/\"><code>bs-css</code></a>, un DSL statiquement typé qui utilise <a href=\"https://emotion.sh\">emotion</a>, ce qui nous permet d'envoyer au client <strong>uniquement les styles requis</strong>.</p>\n<h2>L'approche technique: une static SPA</h2>\n<p>La question qu'on s'est posée : quel est <strong>le moyen le plus efficace de livrer une page de blog</strong> aux lecteurs ?</p>\n<p>Et la réponse qui s'est imposée à nous était dans la veine de ce qu'on avait déjà fait par le passé : une <strong>SPA statique</strong>.</p>\n<p>Qu'est-ce qu'une SPA statique ? C'est un site statique <strong>conçu comme une single page application</strong>. On conçoit le site comme une application React côté client, et on va pré-rendre les pages non pas côté serveur, mais dans notre système d'intégration continue.</p>\n<p>Pourquoi de <strong>l'hébergement statique</strong> ? Parce que c'est moins cher (voire gratuit), qu'on est principalement front et que la dernière fois que je me suis connecté à la console AWS j'y suis resté coincé pendant 5 jours.</p>\n<p>Ce que ça apporte : un <strong>chargement initial extrêmement rapide</strong>, une <strong>navigation optimale</strong> et des <strong>besoins en serveur réduits au minimum</strong>.</p>\n<p>Quand un lecteur arrive sur le site, il récupère une version de la page <strong>déjà rendue</strong> au moment du build, le client ne fait que &quot;hydrater&quot; la page. Lors que le lecteur navigue vers une autre page, le client va <strong>uniquement chercher la donnée dont il a besoin</strong> pour la page de destination.</p>\n<p>En développement local, chaque page démarre avec un <strong>data-store vide</strong>, et les composants vont <strong>demander le chargement des données</strong>. En production, chaque page est livrée <strong>rendue</strong>, avec le data-store <strong>contenant les informations dont elle a besoin</strong>, toute navigation ultérieure sera comme en mode local: les composants vont demander le chargement de ce qui leur manque.</p>\n<p>Ce mode de fonctionnement requiert une certaine discipline concernant les endroits où la donnée peut être stockée. Dans notre cas, on a choisi de la placer dans l'état du composant qui orchestre l'application, et de le faire sous la forme suivante:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">type</span> state = {\n  articles: <span class=\"hljs-module-identifier\">Map</span>.<span class=\"hljs-module-identifier\">String</span>.t(<span class=\"hljs-module-identifier\">RequestStatus</span>.t(<span class=\"hljs-module-identifier\">Result</span>.t(<span class=\"hljs-module-identifier\">Post</span>.t, <span class=\"hljs-module-identifier\">Errors</span>.t))),\n  articleList: <span class=\"hljs-module-identifier\">RequestStatus</span>.t(<span class=\"hljs-module-identifier\">Result</span>.t(array(<span class=\"hljs-module-identifier\">PostShallow</span>.t), <span class=\"hljs-module-identifier\">Errors</span>.t)),\n  podcasts: <span class=\"hljs-module-identifier\">Map</span>.<span class=\"hljs-module-identifier\">String</span>.t(<span class=\"hljs-module-identifier\">RequestStatus</span>.t(<span class=\"hljs-module-identifier\">Result</span>.t(<span class=\"hljs-module-identifier\">Podcast</span>.t, <span class=\"hljs-module-identifier\">Errors</span>.t))),\n  podcastList: <span class=\"hljs-module-identifier\">RequestStatus</span>.t(<span class=\"hljs-module-identifier\">Result</span>.t(array(<span class=\"hljs-module-identifier\">PodcastShallow</span>.t), <span class=\"hljs-module-identifier\">Errors</span>.t)),\n  home: <span class=\"hljs-module-identifier\">RequestStatus</span>.t(<span class=\"hljs-module-identifier\">Result</span>.t(<span class=\"hljs-module-identifier\">Home</span>.t, <span class=\"hljs-module-identifier\">Errors</span>.t)),\n};\n</code></pre>\n<p>Cet état peut stocker <strong>l'intégralité des données du blog</strong>, comme il peut stocker le <strong>minimum possible</strong>. Si vous voulez en savoir plus, n'hésitez pas à naviguer dans les sources du site.</p>\n<p>Une approche alternative est de stocker la donnée requise par chaque URL, mais cette approche s'avère moins efficace au niveau du cache: si on a déjà toutes les données depuis une autre URL, on va quand même devoir les charger à nouveau.</p>\n<h2>Coder le blog</h2>\n<p>Le blog était organisé d'une manière … chaotique. L'emplacement des fichiers markdown dans le repository définissait leur URL sur le site (on devait se dire que c'était une bonne idée à l'époque). Pour plus de perennité, on a choisi de passer à un système où le nom ou l'emplacement du fichier n'avaient pas d'impact sur l'endroit où se retrouve sur le site. Ça nous permet de les organiser par date, par sujet ou par contrib dans le futur sans pour autant influer sur les URLs.</p>\n<p>Avec <a href=\"https://twitter.com/jojmaht\">jojmaht</a>, on a pris la tâche ingrate de bouger et transformer la centaine d'articles existants, avec leurs médias, vers une <strong>organisation à plat</strong>, plus simple à gérer.</p>\n<p>Une fois cette tâche gérée, on n'avait plus qu'à récupérer les posts et à les générer aux URLs qui vont bien.</p>\n<h2>Gérer la retro-compatibilité</h2>\n<p>On a profité de ce chantier pour réécrire les URLs des articles vers des formats plus lisibles (e.g. <code>/articles/js/react</code> -&gt; <code>/articles/introduction-a-react</code>).</p>\n<p>Pour preserver les anciennes URLs, on a indiqué l'ancienne URL des articles dans chaque fichier markdown, et on a généré à ces endroits là une page HTML:</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-meta-keyword\">html</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">http-equiv</span>=<span class=\"hljs-string\">&quot;refresh&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;0;URL=NOUVELLE_URL&quot;</span> /&gt;</span>\n</code></pre>\n<p>On se sert également de cette ancienne URL comme identifiant de page pour notre système de commentaires qui tourne avec disqus parce que j'ai pas trouvé la page pour migrer les URLs sur leur admin.</p>\n<p>Si vous voulez en savoir un peu plus, n'hésitez pas à parcourir <a href=\"https://github.com/putaindecode/putaindecode.io\">la source du projet</a>. Et n'hésitez pas à <a href=\"https://github.com/putaindecode/putaindecode.io/blob/master/CONTRIBUTING.md\">contribuer au blog</a> si l'envie vous vient.</p>\n<p>Bisous.</p>\n"}}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"listsRequests":{"data":{"RE_PRIVATE_NONE":true}},"itemsRequests":{"data":{"RE_PRIVATE_NONE":true}}}</script><head><script defer="defer" src="/public/main.56c69761a03eb0112696.js"></script></head></html>