<!DOCTYPE html><html lang="fr"><head><title data-react-helmet="true">Laissez-vous pousser la barbe, apprenez à écrire des Makefiles | Putain de code</title><meta data-react-helmet="true" charset="UTF-8"/><meta data-react-helmet="true" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" name="viewport"/><meta data-react-helmet="true" content="summary_large_image" name="twitter:card"/><meta data-react-helmet="true" content="Putain de code !" property="og:site_name"/><meta data-react-helmet="true" content="@putaindecode" name="twitter:site"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" property="og:image"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" name="twitter:image"/><meta data-react-helmet="true" content="1500" property="og:image:width"/><meta data-react-helmet="true" content="777" property="og:image:height"/><meta data-react-helmet="true" content="Laissez-vous pousser la barbe, apprenez à écrire des Makefiles | Putain de code" property="og:title"/><meta data-react-helmet="true" content="Laissez-vous pousser la barbe, apprenez à écrire des Makefiles | Putain de code" name="twitter:title"/><meta data-react-helmet="true" content="Un article proposé par madx" name="description"/><link data-react-helmet="true" title="RSS Feed" href="/api/articles/feeds/desc/feed.xml" rel="alternate" type="application/rss+xml"/><link data-react-helmet="true" href="/favicon.ico" rel="shortcut icon"/><link data-react-helmet="true" href="https://putaindecode.io/articles/laissez-vous-pousser-la-barbe-apprenez-a-ecrire-des-makefiles" rel="canonical"/><script>window.PAGES_BOOT_MODE="hydrate";</script></head><div id="root"><style data-emotion="rpcss zx73cm 1lc6tyj 28v1b4">@-webkit-keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}@keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}:root{--page-background-color:#fff;--page-slightly-accented-background-color:#F9F6F6;--page-accented-background-color:#E4EBEE;--page-text-color:#46515B;--link-text-color:#E51D58;--gradient-red-top:#E51D58;--gradient-red-bottom:#CC0613;--code-background-color:#FAF3E1;--one-percent-contrast-color:rgba(0, 0, 0, 0.1);--half-percent-contrast-color:rgba(0, 0, 0, 0.05);}@media (prefers-color-scheme: dark){:root{--page-background-color:#222;--page-slightly-accented-background-color:#171717;--page-accented-background-color:#111;--page-text-color:#ddd;--link-text-color:#F87098;--gradient-red-top:#E51D58;--gradient-red-bottom:#CC0613;--code-background-color:#4F3804;--one-percent-contrast-color:rgba(255, 255, 255, 0.1);--half-percent-contrast-color:rgba(255, 255, 255, 0.05);}}body{padding:0;margin:0;background-color:var(--page-background-color);color:var(--page-text-color);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;overflow-x:hidden;}html{font-size:1em;line-height:1.4;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;}a{color:var(--link-text-color);-webkit-text-decoration:underline;text-decoration:underline;}a:hover{-webkit-text-decoration:none;text-decoration:none;}#root{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}*,*:before,*:after{box-sizing:border-box;}pre,.hljs{color:#adbac7;background:#22272e;}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#f47067;}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#dcbdfb;}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-variable,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id{color:#6cb6ff;}.hljs-regexp,.hljs-string,.hljs-meta .hljs-string{color:#96d0ff;}.hljs-built_in,.hljs-symbol{color:#f69d50;}.hljs-comment,.hljs-code,.hljs-formula{color:#768390;}.hljs-name,.hljs-quote,.hljs-selector-tag,.hljs-selector-pseudo{color:#8ddb8c;}.hljs-subst{color:#adbac7;}.hljs-section{color:#316dca;font-weight:bold;}.hljs-bullet{color:#eac55f;}.hljs-emphasis{color:#adbac7;font-style:italic;}.hljs-strong{color:#adbac7;font-weight:bold;}.hljs-addition{color:#b4f1b4;background-color:#1b4721;}.hljs-deletion{color:#ffd8d3;background-color:#78191b;}</style><style data-emotion="rpcss 9vhaby">.rpcss-9vhaby{background-color:var(--gradient-red-bottom);background-image:linear-gradient(to bottom right, var(--gradient-red-top), var(--gradient-red-bottom));}</style><header class="rpcss-9vhaby" style="background-image:linear-gradient(to bottom right, hsl(177, 100%, 35%), hsl(147, 100%, 30%))"><style data-emotion="rpcss 1qqk0tr">.rpcss-1qqk0tr{padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);}</style><div class="rpcss-1qqk0tr"><style data-emotion="rpcss qx7dny">.rpcss-qx7dny{width:100%;max-width:1024px;margin:0 auto;padding:0 10px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="rpcss-qx7dny"><style data-emotion="rpcss 7s9om2">.rpcss-7s9om2{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding:20px 0 50px;}</style><div class="rpcss-7s9om2"><style data-emotion="rpcss gdpa5c">.rpcss-gdpa5c{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-gdpa5c" href="/"><style data-emotion="rpcss 1lm4738">.rpcss-1lm4738{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;padding-bottom:10px;}</style><div class="rpcss-1lm4738"><style data-emotion="rpcss 13o7eu2">.rpcss-13o7eu2{display:block;}</style><svg class="rpcss-13o7eu2" height="36px" width="36px" viewBox="0 0 36 36"><defs><linearGradient id="PutainDeCodeLogoGradient" x1="50%" x2="50%" y1="0%" y2="127.223881%"><stop offset="0%" stop-color="#E41D57"></stop><stop offset="100%" stop-color="#C60000"></stop></linearGradient></defs><circle cx="18" cy="18" fill="url(#PutainDeCodeLogoGradient)" r="17" stroke="#FFFFFF" stroke-width="2"></circle><polygon fill="#FFFFFF" points="15.9033203 18.2246094 15.9033203 18.3710938 11.2304688 20.5317383 11.2304688 22.8095703 18.0566406 19.184082 18.0566406 17.4116211 11.2304688 13.7788086 11.2304688 16.0639648"></polygon><rect height="14" width="2" fill="#FFFFFF" x="22" y="11"><animate attributeName="opacity" begin="100ms" calcMode="discrete" dur="2s" repeatCount="indefinite" values="1;0"></animate></rect></svg><style data-emotion="rpcss 4cf197">.rpcss-4cf197{width:10px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-4cf197"></div><style data-emotion="rpcss u5k24">.rpcss-u5k24{font-size:22px;color:#fff;font-weight:800;}</style><div aria-level="2" class="rpcss-u5k24" role="heading">Putain de code !</div></div><style data-emotion="rpcss 1nyebg4">.rpcss-1nyebg4{font-size:14px;color:rgba(255, 255, 255, 0.8);text-align:center;}</style><div class="rpcss-1nyebg4">Blog participatif de la communauté dev</div></a></div></div></div></header><style data-emotion="rpcss a4ric9">.rpcss-a4ric9{background-color:var(--page-slightly-accented-background-color);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="rpcss-a4ric9"><style data-emotion="rpcss oeugsb">.rpcss-oeugsb{-webkit-animation:500ms ease-out animation-zx73cm;animation:500ms ease-out animation-zx73cm;}</style><div class="rpcss-oeugsb"><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 1qc2bam">.rpcss-1qc2bam{font-size:42px;font-weight:800;text-align:center;padding-top:40px;line-height:1.2;margin:0;}</style><h1 class="rpcss-1qc2bam">Laissez-vous pousser la barbe, apprenez à écrire des Makefiles</h1><style data-emotion="rpcss obg2kr">.rpcss-obg2kr{font-size:16px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding-top:10px;padding-bottom:40px;color:var(--page-text-color);-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-obg2kr" href="https://github.com/madx"><style data-emotion="rpcss uco8i7">.rpcss-uco8i7{width:32px;height:32px;border-radius:100%;margin-right:10px;}</style><img class="rpcss-uco8i7" alt="madx" src="https://avatars.githubusercontent.com/madx?size=64"/><div>madx<!-- --> <!-- -->•<!-- --> <!-- -->2014/11/03</div></a><style data-emotion="rpcss 15kxmi0">.rpcss-15kxmi0{max-width:640px;width:100%;font-size:18px;margin:0 auto;line-height:1.7;}.rpcss-15kxmi0 h2,.rpcss-15kxmi0 h3,.rpcss-15kxmi0 h4,.rpcss-15kxmi0 h5,.rpcss-15kxmi0 h6{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;font-weight:800;line-height:1.2;}.rpcss-15kxmi0 img{max-width:100%;background-color:rgba(255, 255, 255, 0.75);}.rpcss-15kxmi0 code{font-size:0.9em;font-family:PragmataPro,SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;line-height:1;background-color:var(--code-background-color);margin:0 0.2em;}.rpcss-15kxmi0 pre{padding:10px;overflow-x:auto;font-size:14px;border-radius:10px;border:2px solid var(--one-percent-contrast-color);-webkit-overflow-scrolling:touch;}.rpcss-15kxmi0 pre code{font-size:14px;background-color:transparent;margin:0;}.rpcss-15kxmi0 blockquote{padding-left:20px;margin:0;font-size:16px;border-left:3px solid var(--one-percent-contrast-color);font-style:italic;}.rpcss-15kxmi0 table{width:100%;text-align:center;}.rpcss-15kxmi0 figure{padding:20px 0;}.rpcss-15kxmi0 figcaption{text-align:center;}.rpcss-15kxmi0 a{word-wrap:break-word;}.rpcss-15kxmi0 table thead th{background-color:var(--page-accented-background-color);padding:10px 0;}</style><div class="rpcss-15kxmi0"><p>À l'heure où tout le monde se rue sur des outils comme <a href="/fr/articles/js/gulp/">Gulp</a>,
<a href="/fr/articles/js/grunt/">Grunt</a> ou autres <a href="https://rubygems.org/gems/rake">Rake</a>, certains irréductibles (dont je
fais partie) ont fait le choix d'employer un des outils les plus standards et
emblématiques dont tout développeur a entendu parler au moins une fois dans sa
vie : <em>Make</em>.</p>
<p>Si de prime abord on a l'impression d'un système assez archaïque (ce qui n'est
pas toujours forcément faux), on se rend rapidement compte que <em>Make</em>, couplé à
une petite dose de scripting shell permet rapidement de mettre en place un moyen
de compiler ses fichiers et de lancer des tâches.</p>
<p>Les fichiers de configuration de <em>Make</em> sont appellés <em>Makefiles</em> (oui, ce sont
eux qui ont donné leurs noms aux <code>(Gulp|Grunt|Rake)files</code>). Les instructions
qu'ils contiennent sont exécutées grâce à la commande <code>make</code> dans votre
terminal.</p>
<h1>Hello World</h1>
<p>Je vous propose de commencer en douceur par un classique <em>Hello World</em>. On va
simplement définir une tâche <code>hello-world</code> dont l'action va être d'afficher
<em>&quot;Hello, world&quot;</em> à l'écran (boooring).</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">hello-world:</span>
    echo <span class="hljs-string">&quot;Hello, world&quot;</span>
</code></pre>
<p>Première remarque importante, les indentations dans un <em>Makefile</em> <strong>doivent</strong>
être faites avec des tabulations. Oui, je sais, c'est moche, on dirait du
Python, mais c'est comme ça.</p>
<p>Voilà le genre d'erreurs qu'on se prend si on met des espaces à la place des
tabulations :</p>
<pre><code>Makefile:2: *** séparateur manquant . Arrêt.
</code></pre>
<p>Pour exécuter notre commande, il nous suffit de lancer <code>make hello-world</code> dans
un terminal :</p>
<pre><code class="hljs language-console"><span class="hljs-meta">$</span><span class="bash"> make hello-world</span>
echo &quot;Hello, world&quot;
Hello, world
</code></pre>
<p>Décortiquons un peu cette exécution. Pour chaque commande qu'il exécute, <em>Make</em>
affiche la commande complète avant d'afficher la sortie standard de ladite
commande. C'est souvent très pratique car toutes les variables (on va revenir là
dessus) qu'on met dans la commande sont résolues, et on voit clairement ce que
<em>Make</em> exécute. Par contre, dans certains cas on s'en fout un peu, on peut alors
préfixer la ligne à rendre silencieuse par un <code>@</code>, comme ça :</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">hello-world:</span>
    @ echo <span class="hljs-string">&quot;Hello, world&quot;</span>
</code></pre>
<pre><code class="hljs language-console"><span class="hljs-meta">$</span><span class="bash"> make hello-world</span>
Hello, world
</code></pre>
<h1>Règles, cibles, recettes et pré-requis</h1>
<p>OK, jusque là c'est génial, on a un super outil pour lancer des commandes qu'on
pourrait déjà stocker dans un bête script shell. Pas super utile finalement.</p>
<p>Bon, on va corser un peu les choses et commencer par définir un peu de
terminologie avant que vous soyez totalement largués.</p>
<p>Un <em>Makefile</em> est une collection de <strong>règles</strong>, chacune étant composée d'une
<strong>cible</strong>, de <strong>pré-requis</strong> (ou pas) et d'une <strong>recette</strong>. Dans notre exemple
précédent, <code>hello-world</code> est la cible et <code>@ echo &quot;Hello, world&quot;</code> est la recette
de la règle. Elle ne spécifie par contre pas de pré-requis.</p>
<p>Relisez trois ou quatre fois le paragraphe précédent jusqu'à ce que ce soit bien
imprimé.</p>
<p>Vous l'aurez compris, on invoque une règle depuis la ligne de commande en
spécifiant le nom de sa cible après la commande <code>make</code>. Si on ne précise rien,
c'est la première règle trouvée qui est exécutée (donc dans notre cas,
<code>hello-world</code>).</p>
<p>Les pré-requis sont déclarés après la cible. On pourrait par exemple ajouter un
<code>sauter-une-ligne</code> comme pré-requis à notre cible <code>hello-world</code> :</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">hello-world: sauter-une-ligne</span>
    @ echo <span class="hljs-string">&quot;Hello, world&quot;</span>

<span class="hljs-section">sauter-une-ligne:</span>
    @ echo
</code></pre>
<pre><code class="hljs language-console"><span class="hljs-meta">$</span><span class="bash"> make hello-world</span>

Hello, world
</code></pre>
<p>Facile, non ? Ok alors on peut <em>vraiment</em> attaquer les choses sérieuses.</p>
<h1>Construire des fichiers</h1>
<p>Les pré-requis sont particulièrement pratiques quand on veut construire un
fichier depuis un autre, ce qui est la principale action d'à peu près tout
processus de compilation (paraît même que c'est grosso modo la définition de la
compilation).</p>
<p>On peut par exemple écrire un <em>Makefile</em> nous permettant de compiler un fichier
<em>Markdown</em> en <em>HTML</em> :</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">article.html: article.md</span>
    marked article.md &gt; article.html
</code></pre>
<p>Cette règle spécifie simplement que pour construire le fichier <code>article.html</code>
j'ai besoin du fichier <code>article.md</code> et que j'utilise la commande
<a href="https://www.npmjs.org/package/marked"><code>marked</code></a> pour construire le fichier. Essayez, vous verrez, c'est
magique.</p>
<p>Là où ça devient intéressant, c'est que si je lance de nouveau
<code>make article.html</code>, rien ne se passe. Eh oui, <em>Make</em> vérifie les dates de
modification des pré-requis et les compare avec la date de modification de la
cible pour savoir s'il doit où non reconstruire la cible.</p>
<p>On peut bien sûr aller plus loin en ayant des fichiers qui dépendent de
fichiers, qui à leur tour dépendent de fichiers, …</p>
<p><a name="ref-phony-target"></a></p>
<p>On peut aussi avoir une cible factice qui ne représente pas un fichier et qui
elle-même dépend de plusieurs fichiers
(<code>website: index.html apropos.html contact.html</code>).</p>
<h1>Variables et substitutions</h1>
<p>La syntaxe des variables dans un <em>Makefile</em> ressemblent beaucoup aux variables
de votre Shell, <em>mais pas tout à fait</em>.</p>
<pre><code class="hljs language-makefile">SOURCE = index.md
DESTINATION = index.html

<span class="hljs-section">${DESTINATION}: ${SOURCE}</span>
  marked ${SOURCE} &gt; ${DESTINATION}
</code></pre>
<p>On peut aussi utiliser une substitution pour s'éviter de tout retaper. La
syntaxe pour ça est assez simple et se passe d'explications :</p>
<pre><code class="hljs language-makefile">SOURCE = index.md
DESTINATION = ${SOURCE:.md=.html}
</code></pre>
<p>Là où ça devient beaucoup plus intéressant c'est qu'on peut stocker des listes
dans une variable. Pour ça, pas vraiment d'effort à faire, il suffit de rajouter
des noms à la suite :</p>
<pre><code class="hljs language-makefile">SOURCE = index.md article.md
DESTINATION = ${SOURCE:.md=.html}
</code></pre>
<p>Attention par contre ! En faisant ça si vous utilisez <code>${SOURCE}</code> comme cible
d'une règle, vous allez définir plusieurs règles d'un coup, ce qui n'est peut
être pas ce que vous voulez.</p>
<p>On peut contourner ça assez simplement en utilisant une substitution au niveau
de la règle. La syntaxe est un poil différente :</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">%.html: %.md</span>
  [...]
</code></pre>
<p>Vous l'aurez compris, <code>%</code> est identique dans la cible et dans la dépendance,
donc avec cette règle si vous faites un <code>make index.html</code>, <em>Make</em> va tenter de
construire la dépendance <code>index.md</code> avant tout.</p>
<p>Un problème se pose à nous avec cette syntaxe : « Bah merde, comment je récupère
les noms de fichiers là ? »</p>
<h1>Variables spéciales</h1>
<p>Superbe transition étant donné qu'on va parler ici de quelques variables
spéciales bien pratiques !</p>
<ul>
<li><code>$@</code> contient le nom de la cible de la règle en cours d'exécution ;</li>
<li><code>$^</code> contient la liste des dépendances de la règle (la flèche pointe vers la
liste de dépendances) ;</li>
<li><code>$&lt;</code> contient la première dépendance de la règle (la flèche pointe à gauche,
là où est la dépendance).</li>
</ul>
<p>À l'aide de celles-ci on peut du coup compléter notre exemple précédent :</p>
<pre><code class="hljs language-makefile"><span class="hljs-section">%.html: %.md</span>
  marked <span class="hljs-variable">$&lt;</span> &gt; <span class="hljs-variable">$@</span>
  [...]
</code></pre>
<h1>Fonctions</h1>
<p>Pour faciliter quelques opérations, <em>Make</em> fournit un ensemble de fonctions de
base. Appeler ces fonctions rappelle un peu la façon dont on lance une commande
dans un sous-shell en Bash : <code>$(fonction argument1 argument2)</code>.</p>
<p>Voici une petite démonstration de <code>wildcard</code>, <code>addsuffix</code> et <code>basename</code> dont
vous vous doutez sans doute les effets :</p>
<pre><code class="hljs language-makefile">SOURCES = <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> *.md)</span>
DESTINATIONS = <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> .html,$(<span class="hljs-built_in">basename</span> ${SOURCES})</span>)

<span class="hljs-section">all: ${DESTINATIONS}</span>

<span class="hljs-section">%.html: %.md</span>
  marked <span class="hljs-variable">$&lt;</span> &gt; <span class="hljs-variable">$@</span>
</code></pre>
<p>L'exemple construit dynamiquement la liste des fichiers HTML à produire à partir
de la liste des fichiers <em>Markdown</em> disponibles puis définit une règle <code>all</code>
permettant de tout construire d'un coup, et une règle définissant compiler
unitairement un fichier <em>Markdown</em> vers HTML.</p>
<p>Vous noterez qu'<code>addsuffix</code>/<code>basename</code> peut être remplacé par une substitution
simple comme on a vu précédemment.</p>
<p>Je vous invite à fouiller <a href="https://www.gnu.org/software/make/manual/make.html#Functions">le chapitre sur les fonctions du
manuel</a>.</p>
<h1>La cible <code>.PHONY</code></h1>
<p>Dans certains cas la cible d'une règle ne représente pas un fichier (c'était le
cas de notre cible <code>website</code> <a href="#ref-phony-target">un peu plus haut</a>).</p>
<p>Dans ces cas-là, on va vouloir exécuter la règle quoi qu'il arrive, comme si la
cible était tout le temps périmée.</p>
<p>Une cible particulière existe pour ça : <code>.PHONY</code>. Toutes les dépendances de
cette cible seront marquées comme (traduction pourrie) imposteurs (<em>phony</em>
donc).</p>
<p>Pour reprendre l'exemple précédent, on déclarera donc :</p>
<pre><code class="hljs language-makefile"><span class="hljs-meta"><span class="hljs-meta-keyword">.PHONY</span>: website</span>

<span class="hljs-section">website: index.html apropos.html contact.html</span>
  [...]
</code></pre>
<p>Désormais, chaque appel à <code>make website</code> tentera de construire les dépendances
et exécutera les commandes de la recette de la règle.</p>
<h1>Un exemple complet</h1>
<p>L'exemple suivant permet de compiler un site Web depuis un ensemble de fichiers
<em>Markdown</em>.</p>
<pre><code class="hljs language-makefile">SOURCES = <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> src/*.md)</span>
DESTINATIONS = ${SOURCES:src/%.md=build/%.html}

<span class="hljs-section">all: ${DESTINATIONS}</span>

<span class="hljs-section">info:</span>
    @ echo Will build ${DESTINATIONS} from ${SOURCES}

<span class="hljs-section">clean:</span>
    rm -f ${DESTINATIONS}

<span class="hljs-section">build/%.html: src/%.md</span>
    mkdir -p build
    marked <span class="hljs-variable">$&lt;</span> &gt; <span class="hljs-variable">$@</span>

<span class="hljs-meta"><span class="hljs-meta-keyword">.PHONY</span>: all info clean</span>
</code></pre>
<p>Vous noterez que comme on stocke nos résultats dans le dossier <code>build</code>, il faut
potentiellement le créer quand on compile un fichier dedans.</p>
<h1>Pour aller plus loin</h1>
<p>Il existe bien d'autres fonctionnalités dans <em>Make</em> (du moins dans <em>GNU Make</em>),
avec notamment :</p>
<ul>
<li>Les <a href="https://www.gnu.org/software/make/manual/make.html#Canned-Recipes"><em>canned recipes</em></a> (recettes en boîte), permettant de
définir un bout de règle réutilisable à plusieurs endroits.</li>
<li>Des <a href="https://www.gnu.org/software/make/manual/make.html#Functions">expressions conditionnelles</a> pour avoir des tests
dans votre <em>Makefile</em> et effectuer des traitements différents selon
l'environnement.</li>
<li>Les <a href="https://www.gnu.org/software/make/manual/make.html##Prerequisite-Types">règles en <em>order only</em></a> qui permettent d'indiquer une
dépendance dont la date de modification ne doit pas être prise en compte (on
peut s'en servir pour éviter le <code>mkdir</code> dans l'exemple complet).</li>
<li>Et <a href="https://www.gnu.org/software/make/manual/make.html#Functions">plein d'autres fonctions</a> bien pratiques !</li>
</ul>
<p>Je vous invite aussi à jeter un coup d'œil au <a href="https://github.com/madx/veil/"><em>Makefile</em> de Veil</a>, un
outil que j'utilise pour générer des sites statiques à partir de fichiers
<em>Markdown</em> (ah bah tiens, comme dans mes exemples, c'est rigolo). Il y a plein
de fonctionnalités de <em>Make</em> utilisées dans ce projet et je pense que ça peut
être source d'idées.</p>
<p>Voilà pour cette premier introduction à <em>Make</em>, j'espère que ça vous a plu et
que vous êtes fin prêts à affronter tous ces bouseux avec leur système de build
à base de streams, de brocolis et autres râteaux.</p>
</div><style data-emotion="rpcss unyj6i">.rpcss-unyj6i{max-width:640px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;margin:20px auto;padding:20px;background-color:var(--page-background-color);border-radius:10px;box-shadow:0 15px 15px -5px rgba(0, 0, 0, 0.2);}@media (max-width: 540px){.rpcss-unyj6i{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-unyj6i"><style data-emotion="rpcss ty7r4z">.rpcss-ty7r4z{font-weight:800;}</style><div class="rpcss-ty7r4z">Vous avez aimé cet article?</div><style data-emotion="rpcss klacsp">.rpcss-klacsp{width:0;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-klacsp"></div><style data-emotion="rpcss 1pkr03v">.rpcss-1pkr03v{background-color:#00aced;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:800;}.rpcss-1pkr03v:active{opacity:0.5;}</style><a class="rpcss-1pkr03v" href="https://www.twitter.com/intent/tweet?text=Laissez-vous%20pousser%20la%20barbe%2C%20apprenez%20%C3%A0%20%C3%A9crire%20des%20Makefiles%20sur%20%40PutainDeCode%20https%3A%2F%2Fputaindecode.io%2Farticles%2Flaissez-vous-pousser-la-barbe-apprenez-a-ecrire-des-makefiles" target="_blank">Le partager sur Twitter</a></div><style data-emotion="rpcss x4iqxe">.rpcss-x4iqxe{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;text-align:center;padding:20px;}</style><div class="rpcss-x4iqxe"><style data-emotion="rpcss gein6x">.rpcss-gein6x{font-size:20px;-webkit-text-decoration:none;text-decoration:none;color:#1E49B5;}</style><a class="rpcss-gein6x" href="/articles">← Articles</a></div><style data-emotion="rpcss 8bodgl">.rpcss-8bodgl{max-width:640px;width:100%;margin:0 auto;padding:20px 0;}</style><div class="rpcss-8bodgl" id="disqus_thread"></div></div></div></div></div><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 1vau6rl">.rpcss-1vau6rl{margin:20px 0;background-color:var(--page-accented-background-color);border-radius:10px;padding:20px;}</style><div class="rpcss-1vau6rl"><style data-emotion="rpcss 1gz1i1h">.rpcss-1gz1i1h{font-size:32px;font-weight:800;margin-bottom:20px;text-align:center;}</style><div aria-level="2" class="rpcss-1gz1i1h" role="heading">Ne rien rater</div><style data-emotion="rpcss 1wbispj">.rpcss-1wbispj{font-size:18px;margin-bottom:10px;text-align:center;}</style><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur les réseaux</div><style data-emotion="rpcss 1hyoz7m">.rpcss-1hyoz7m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}</style><div class="rpcss-1hyoz7m"><a href="https://twitter.com/PutainDeCode"><img alt="Twitter" height="48" src="/public/images/website/twitter.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://facebook.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/facebook.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://github.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/github.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://itunes.apple.com/fr/podcast/putain-de-code-!/id1185311825"><img alt="Apple Podcast" height="48" src="/public/images/website/apple-podcast.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://soundcloud.com/putaindecode"><img alt="Soundcloud" height="48" src="/public/images/website/soundcloud.svg" width="48"/></a></div><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur le chat</div><div class="rpcss-1hyoz7m"><a href="https://discord.gg/jtbGNNc"><img alt="Discord" height="48" src="/public/images/website/discord.svg" width="48"/></a></div></div></div></div><style data-emotion="rpcss zs8kw7">.rpcss-zs8kw7{background-color:#222;padding:20px 0;}</style><footer class="rpcss-zs8kw7"><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 79elbk">.rpcss-79elbk{position:relative;}</style><div class="rpcss-79elbk"><style data-emotion="rpcss 1hle0ni">.rpcss-1hle0ni{position:absolute;left:0;top:50%;color:#fff;-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1hle0ni" href="/api/articles/feeds/desc/feed.xml"><style data-emotion="rpcss lvyu5j">.rpcss-lvyu5j{margin-right:10px;}</style><img class="rpcss-lvyu5j" alt="Flux RSS" height="16" src="/public/images/website/rss-feed.svg" width="16"/><style data-emotion="rpcss um3i31">@media (max-width: 400px){.rpcss-um3i31{display:none;}}</style><div class="rpcss-um3i31">Flux RSS</div></a><style data-emotion="rpcss 12cp4l7">.rpcss-12cp4l7{color:rgba(255, 255, 255, 0.5);text-align:center;font-size:14px;}</style><div class="rpcss-12cp4l7">© 2021 Putain de code !</div><style data-emotion="rpcss 1w98uy3">.rpcss-1w98uy3{position:absolute;right:0;top:50%;color:#fff;-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1w98uy3" href="https://github.com/putaindecode/putaindecode.io">GitHub</a></div></div></div></footer></div><script id="initialData" type="text/data">{"lists":{"RE_PRIVATE_NONE":true},"items":{"k":"articles","v":{"k":"laissez-vous-pousser-la-barbe-apprenez-a-ecrire-des-makefiles","v":{"_0":{"TAG":0,"_0":{"slug":"laissez-vous-pousser-la-barbe-apprenez-a-ecrire-des-makefiles","filename":"2014-11-03-laissez-vous-pousser-la-barbe-apprenez-a-ecrire-des-makefiles","title":"Laissez-vous pousser la barbe, apprenez à écrire des Makefiles","date":"Mon, 03 Nov 2014 00:00:00 GMT","draft":false,"meta":{"date":"2014-11-03T00:00:00.000Z","title":"Laissez-vous pousser la barbe, apprenez à écrire des Makefiles","author":"madx","oldSlug":"make","slug":"laissez-vous-pousser-la-barbe-apprenez-a-ecrire-des-makefiles"},"body":"<p>À l'heure où tout le monde se rue sur des outils comme <a href=\"/fr/articles/js/gulp/\">Gulp</a>,\n<a href=\"/fr/articles/js/grunt/\">Grunt</a> ou autres <a href=\"https://rubygems.org/gems/rake\">Rake</a>, certains irréductibles (dont je\nfais partie) ont fait le choix d'employer un des outils les plus standards et\nemblématiques dont tout développeur a entendu parler au moins une fois dans sa\nvie : <em>Make</em>.</p>\n<p>Si de prime abord on a l'impression d'un système assez archaïque (ce qui n'est\npas toujours forcément faux), on se rend rapidement compte que <em>Make</em>, couplé à\nune petite dose de scripting shell permet rapidement de mettre en place un moyen\nde compiler ses fichiers et de lancer des tâches.</p>\n<p>Les fichiers de configuration de <em>Make</em> sont appellés <em>Makefiles</em> (oui, ce sont\neux qui ont donné leurs noms aux <code>(Gulp|Grunt|Rake)files</code>). Les instructions\nqu'ils contiennent sont exécutées grâce à la commande <code>make</code> dans votre\nterminal.</p>\n<h1>Hello World</h1>\n<p>Je vous propose de commencer en douceur par un classique <em>Hello World</em>. On va\nsimplement définir une tâche <code>hello-world</code> dont l'action va être d'afficher\n<em>&quot;Hello, world&quot;</em> à l'écran (boooring).</p>\n<pre><code class=\"hljs language-makefile\"><span class=\"hljs-section\">hello-world:</span>\n    echo <span class=\"hljs-string\">&quot;Hello, world&quot;</span>\n</code></pre>\n<p>Première remarque importante, les indentations dans un <em>Makefile</em> <strong>doivent</strong>\nêtre faites avec des tabulations. Oui, je sais, c'est moche, on dirait du\nPython, mais c'est comme ça.</p>\n<p>Voilà le genre d'erreurs qu'on se prend si on met des espaces à la place des\ntabulations :</p>\n<pre><code>Makefile:2: *** séparateur manquant . Arrêt.\n</code></pre>\n<p>Pour exécuter notre commande, il nous suffit de lancer <code>make hello-world</code> dans\nun terminal :</p>\n<pre><code class=\"hljs language-console\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> make hello-world</span>\necho &quot;Hello, world&quot;\nHello, world\n</code></pre>\n<p>Décortiquons un peu cette exécution. Pour chaque commande qu'il exécute, <em>Make</em>\naffiche la commande complète avant d'afficher la sortie standard de ladite\ncommande. C'est souvent très pratique car toutes les variables (on va revenir là\ndessus) qu'on met dans la commande sont résolues, et on voit clairement ce que\n<em>Make</em> exécute. Par contre, dans certains cas on s'en fout un peu, on peut alors\npréfixer la ligne à rendre silencieuse par un <code>@</code>, comme ça :</p>\n<pre><code class=\"hljs language-makefile\"><span class=\"hljs-section\">hello-world:</span>\n    @ echo <span class=\"hljs-string\">&quot;Hello, world&quot;</span>\n</code></pre>\n<pre><code class=\"hljs language-console\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> make hello-world</span>\nHello, world\n</code></pre>\n<h1>Règles, cibles, recettes et pré-requis</h1>\n<p>OK, jusque là c'est génial, on a un super outil pour lancer des commandes qu'on\npourrait déjà stocker dans un bête script shell. Pas super utile finalement.</p>\n<p>Bon, on va corser un peu les choses et commencer par définir un peu de\nterminologie avant que vous soyez totalement largués.</p>\n<p>Un <em>Makefile</em> est une collection de <strong>règles</strong>, chacune étant composée d'une\n<strong>cible</strong>, de <strong>pré-requis</strong> (ou pas) et d'une <strong>recette</strong>. Dans notre exemple\nprécédent, <code>hello-world</code> est la cible et <code>@ echo &quot;Hello, world&quot;</code> est la recette\nde la règle. Elle ne spécifie par contre pas de pré-requis.</p>\n<p>Relisez trois ou quatre fois le paragraphe précédent jusqu'à ce que ce soit bien\nimprimé.</p>\n<p>Vous l'aurez compris, on invoque une règle depuis la ligne de commande en\nspécifiant le nom de sa cible après la commande <code>make</code>. Si on ne précise rien,\nc'est la première règle trouvée qui est exécutée (donc dans notre cas,\n<code>hello-world</code>).</p>\n<p>Les pré-requis sont déclarés après la cible. On pourrait par exemple ajouter un\n<code>sauter-une-ligne</code> comme pré-requis à notre cible <code>hello-world</code> :</p>\n<pre><code class=\"hljs language-makefile\"><span class=\"hljs-section\">hello-world: sauter-une-ligne</span>\n    @ echo <span class=\"hljs-string\">&quot;Hello, world&quot;</span>\n\n<span class=\"hljs-section\">sauter-une-ligne:</span>\n    @ echo\n</code></pre>\n<pre><code class=\"hljs language-console\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> make hello-world</span>\n\nHello, world\n</code></pre>\n<p>Facile, non ? Ok alors on peut <em>vraiment</em> attaquer les choses sérieuses.</p>\n<h1>Construire des fichiers</h1>\n<p>Les pré-requis sont particulièrement pratiques quand on veut construire un\nfichier depuis un autre, ce qui est la principale action d'à peu près tout\nprocessus de compilation (paraît même que c'est grosso modo la définition de la\ncompilation).</p>\n<p>On peut par exemple écrire un <em>Makefile</em> nous permettant de compiler un fichier\n<em>Markdown</em> en <em>HTML</em> :</p>\n<pre><code class=\"hljs language-makefile\"><span class=\"hljs-section\">article.html: article.md</span>\n    marked article.md &gt; article.html\n</code></pre>\n<p>Cette règle spécifie simplement que pour construire le fichier <code>article.html</code>\nj'ai besoin du fichier <code>article.md</code> et que j'utilise la commande\n<a href=\"https://www.npmjs.org/package/marked\"><code>marked</code></a> pour construire le fichier. Essayez, vous verrez, c'est\nmagique.</p>\n<p>Là où ça devient intéressant, c'est que si je lance de nouveau\n<code>make article.html</code>, rien ne se passe. Eh oui, <em>Make</em> vérifie les dates de\nmodification des pré-requis et les compare avec la date de modification de la\ncible pour savoir s'il doit où non reconstruire la cible.</p>\n<p>On peut bien sûr aller plus loin en ayant des fichiers qui dépendent de\nfichiers, qui à leur tour dépendent de fichiers, …</p>\n<p><a name=\"ref-phony-target\"></a></p>\n<p>On peut aussi avoir une cible factice qui ne représente pas un fichier et qui\nelle-même dépend de plusieurs fichiers\n(<code>website: index.html apropos.html contact.html</code>).</p>\n<h1>Variables et substitutions</h1>\n<p>La syntaxe des variables dans un <em>Makefile</em> ressemblent beaucoup aux variables\nde votre Shell, <em>mais pas tout à fait</em>.</p>\n<pre><code class=\"hljs language-makefile\">SOURCE = index.md\nDESTINATION = index.html\n\n<span class=\"hljs-section\">${DESTINATION}: ${SOURCE}</span>\n  marked ${SOURCE} &gt; ${DESTINATION}\n</code></pre>\n<p>On peut aussi utiliser une substitution pour s'éviter de tout retaper. La\nsyntaxe pour ça est assez simple et se passe d'explications :</p>\n<pre><code class=\"hljs language-makefile\">SOURCE = index.md\nDESTINATION = ${SOURCE:.md=.html}\n</code></pre>\n<p>Là où ça devient beaucoup plus intéressant c'est qu'on peut stocker des listes\ndans une variable. Pour ça, pas vraiment d'effort à faire, il suffit de rajouter\ndes noms à la suite :</p>\n<pre><code class=\"hljs language-makefile\">SOURCE = index.md article.md\nDESTINATION = ${SOURCE:.md=.html}\n</code></pre>\n<p>Attention par contre ! En faisant ça si vous utilisez <code>${SOURCE}</code> comme cible\nd'une règle, vous allez définir plusieurs règles d'un coup, ce qui n'est peut\nêtre pas ce que vous voulez.</p>\n<p>On peut contourner ça assez simplement en utilisant une substitution au niveau\nde la règle. La syntaxe est un poil différente :</p>\n<pre><code class=\"hljs language-makefile\"><span class=\"hljs-section\">%.html: %.md</span>\n  [...]\n</code></pre>\n<p>Vous l'aurez compris, <code>%</code> est identique dans la cible et dans la dépendance,\ndonc avec cette règle si vous faites un <code>make index.html</code>, <em>Make</em> va tenter de\nconstruire la dépendance <code>index.md</code> avant tout.</p>\n<p>Un problème se pose à nous avec cette syntaxe : « Bah merde, comment je récupère\nles noms de fichiers là ? »</p>\n<h1>Variables spéciales</h1>\n<p>Superbe transition étant donné qu'on va parler ici de quelques variables\nspéciales bien pratiques !</p>\n<ul>\n<li><code>$@</code> contient le nom de la cible de la règle en cours d'exécution ;</li>\n<li><code>$^</code> contient la liste des dépendances de la règle (la flèche pointe vers la\nliste de dépendances) ;</li>\n<li><code>$&lt;</code> contient la première dépendance de la règle (la flèche pointe à gauche,\nlà où est la dépendance).</li>\n</ul>\n<p>À l'aide de celles-ci on peut du coup compléter notre exemple précédent :</p>\n<pre><code class=\"hljs language-makefile\"><span class=\"hljs-section\">%.html: %.md</span>\n  marked <span class=\"hljs-variable\">$&lt;</span> &gt; <span class=\"hljs-variable\">$@</span>\n  [...]\n</code></pre>\n<h1>Fonctions</h1>\n<p>Pour faciliter quelques opérations, <em>Make</em> fournit un ensemble de fonctions de\nbase. Appeler ces fonctions rappelle un peu la façon dont on lance une commande\ndans un sous-shell en Bash : <code>$(fonction argument1 argument2)</code>.</p>\n<p>Voici une petite démonstration de <code>wildcard</code>, <code>addsuffix</code> et <code>basename</code> dont\nvous vous doutez sans doute les effets :</p>\n<pre><code class=\"hljs language-makefile\">SOURCES = <span class=\"hljs-variable\">$(<span class=\"hljs-built_in\">wildcard</span> *.md)</span>\nDESTINATIONS = <span class=\"hljs-variable\">$(<span class=\"hljs-built_in\">addsuffix</span> .html,$(<span class=\"hljs-built_in\">basename</span> ${SOURCES})</span>)\n\n<span class=\"hljs-section\">all: ${DESTINATIONS}</span>\n\n<span class=\"hljs-section\">%.html: %.md</span>\n  marked <span class=\"hljs-variable\">$&lt;</span> &gt; <span class=\"hljs-variable\">$@</span>\n</code></pre>\n<p>L'exemple construit dynamiquement la liste des fichiers HTML à produire à partir\nde la liste des fichiers <em>Markdown</em> disponibles puis définit une règle <code>all</code>\npermettant de tout construire d'un coup, et une règle définissant compiler\nunitairement un fichier <em>Markdown</em> vers HTML.</p>\n<p>Vous noterez qu'<code>addsuffix</code>/<code>basename</code> peut être remplacé par une substitution\nsimple comme on a vu précédemment.</p>\n<p>Je vous invite à fouiller <a href=\"https://www.gnu.org/software/make/manual/make.html#Functions\">le chapitre sur les fonctions du\nmanuel</a>.</p>\n<h1>La cible <code>.PHONY</code></h1>\n<p>Dans certains cas la cible d'une règle ne représente pas un fichier (c'était le\ncas de notre cible <code>website</code> <a href=\"#ref-phony-target\">un peu plus haut</a>).</p>\n<p>Dans ces cas-là, on va vouloir exécuter la règle quoi qu'il arrive, comme si la\ncible était tout le temps périmée.</p>\n<p>Une cible particulière existe pour ça : <code>.PHONY</code>. Toutes les dépendances de\ncette cible seront marquées comme (traduction pourrie) imposteurs (<em>phony</em>\ndonc).</p>\n<p>Pour reprendre l'exemple précédent, on déclarera donc :</p>\n<pre><code class=\"hljs language-makefile\"><span class=\"hljs-meta\"><span class=\"hljs-meta-keyword\">.PHONY</span>: website</span>\n\n<span class=\"hljs-section\">website: index.html apropos.html contact.html</span>\n  [...]\n</code></pre>\n<p>Désormais, chaque appel à <code>make website</code> tentera de construire les dépendances\net exécutera les commandes de la recette de la règle.</p>\n<h1>Un exemple complet</h1>\n<p>L'exemple suivant permet de compiler un site Web depuis un ensemble de fichiers\n<em>Markdown</em>.</p>\n<pre><code class=\"hljs language-makefile\">SOURCES = <span class=\"hljs-variable\">$(<span class=\"hljs-built_in\">wildcard</span> src/*.md)</span>\nDESTINATIONS = ${SOURCES:src/%.md=build/%.html}\n\n<span class=\"hljs-section\">all: ${DESTINATIONS}</span>\n\n<span class=\"hljs-section\">info:</span>\n    @ echo Will build ${DESTINATIONS} from ${SOURCES}\n\n<span class=\"hljs-section\">clean:</span>\n    rm -f ${DESTINATIONS}\n\n<span class=\"hljs-section\">build/%.html: src/%.md</span>\n    mkdir -p build\n    marked <span class=\"hljs-variable\">$&lt;</span> &gt; <span class=\"hljs-variable\">$@</span>\n\n<span class=\"hljs-meta\"><span class=\"hljs-meta-keyword\">.PHONY</span>: all info clean</span>\n</code></pre>\n<p>Vous noterez que comme on stocke nos résultats dans le dossier <code>build</code>, il faut\npotentiellement le créer quand on compile un fichier dedans.</p>\n<h1>Pour aller plus loin</h1>\n<p>Il existe bien d'autres fonctionnalités dans <em>Make</em> (du moins dans <em>GNU Make</em>),\navec notamment :</p>\n<ul>\n<li>Les <a href=\"https://www.gnu.org/software/make/manual/make.html#Canned-Recipes\"><em>canned recipes</em></a> (recettes en boîte), permettant de\ndéfinir un bout de règle réutilisable à plusieurs endroits.</li>\n<li>Des <a href=\"https://www.gnu.org/software/make/manual/make.html#Functions\">expressions conditionnelles</a> pour avoir des tests\ndans votre <em>Makefile</em> et effectuer des traitements différents selon\nl'environnement.</li>\n<li>Les <a href=\"https://www.gnu.org/software/make/manual/make.html##Prerequisite-Types\">règles en <em>order only</em></a> qui permettent d'indiquer une\ndépendance dont la date de modification ne doit pas être prise en compte (on\npeut s'en servir pour éviter le <code>mkdir</code> dans l'exemple complet).</li>\n<li>Et <a href=\"https://www.gnu.org/software/make/manual/make.html#Functions\">plein d'autres fonctions</a> bien pratiques !</li>\n</ul>\n<p>Je vous invite aussi à jeter un coup d'œil au <a href=\"https://github.com/madx/veil/\"><em>Makefile</em> de Veil</a>, un\noutil que j'utilise pour générer des sites statiques à partir de fichiers\n<em>Markdown</em> (ah bah tiens, comme dans mes exemples, c'est rigolo). Il y a plein\nde fonctionnalités de <em>Make</em> utilisées dans ce projet et je pense que ça peut\nêtre source d'idées.</p>\n<p>Voilà pour cette premier introduction à <em>Make</em>, j'espère que ça vous a plu et\nque vous êtes fin prêts à affronter tous ces bouseux avec leur système de build\nà base de streams, de brocolis et autres râteaux.</p>\n"}}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"listsRequests":{"data":{"RE_PRIVATE_NONE":true}},"itemsRequests":{"data":{"RE_PRIVATE_NONE":true}}}</script><head><script defer="defer" src="/public/main.56c69761a03eb0112696.js"></script></head></html>