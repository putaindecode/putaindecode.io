<!DOCTYPE html><html lang="fr"><head><title data-react-helmet="true">Quelques retours sur React et le rendu serveur | Putain de code</title><meta data-react-helmet="true" charset="UTF-8"/><meta data-react-helmet="true" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" name="viewport"/><meta data-react-helmet="true" content="summary_large_image" name="twitter:card"/><meta data-react-helmet="true" content="Putain de code !" property="og:site_name"/><meta data-react-helmet="true" content="@putaindecode" name="twitter:site"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" property="og:image"/><meta data-react-helmet="true" content="https://putaindecode.io/public/images/website/share.jpg" name="twitter:image"/><meta data-react-helmet="true" content="1500" property="og:image:width"/><meta data-react-helmet="true" content="777" property="og:image:height"/><meta data-react-helmet="true" content="Quelques retours sur React et le rendu serveur | Putain de code" property="og:title"/><meta data-react-helmet="true" content="Quelques retours sur React et le rendu serveur | Putain de code" name="twitter:title"/><meta data-react-helmet="true" content="Un article proposé par lionelB" name="description"/><link data-react-helmet="true" title="RSS Feed" href="/api/articles/feeds/desc/feed.xml" rel="alternate" type="application/rss+xml"/><link data-react-helmet="true" href="/favicon.ico" rel="shortcut icon"/><link data-react-helmet="true" href="https://putaindecode.io/articles/quelques-retours-sur-react-et-le-rendu-serveur" rel="canonical"/><script>window.PAGES_BOOT_MODE="hydrate";</script></head><div id="root"><style data-emotion="rpcss zx73cm 1lc6tyj 28v1b4">@-webkit-keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}@keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}:root{--page-background-color:#fff;--page-slightly-accented-background-color:#F9F6F6;--page-accented-background-color:#E4EBEE;--page-text-color:#46515B;--link-text-color:#E51D58;--gradient-red-top:#E51D58;--gradient-red-bottom:#CC0613;--code-background-color:#FAF3E1;--one-percent-contrast-color:rgba(0, 0, 0, 0.1);--half-percent-contrast-color:rgba(0, 0, 0, 0.05);}@media (prefers-color-scheme: dark){:root{--page-background-color:#222;--page-slightly-accented-background-color:#171717;--page-accented-background-color:#111;--page-text-color:#ddd;--link-text-color:#F87098;--gradient-red-top:#E51D58;--gradient-red-bottom:#CC0613;--code-background-color:#4F3804;--one-percent-contrast-color:rgba(255, 255, 255, 0.1);--half-percent-contrast-color:rgba(255, 255, 255, 0.05);}}body{padding:0;margin:0;background-color:var(--page-background-color);color:var(--page-text-color);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;overflow-x:hidden;}html{font-size:1em;line-height:1.4;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;}a{color:var(--link-text-color);-webkit-text-decoration:underline;text-decoration:underline;}a:hover{-webkit-text-decoration:none;text-decoration:none;}#root{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}*,*:before,*:after{box-sizing:border-box;}pre,.hljs{color:#adbac7;background:#22272e;}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#f47067;}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#dcbdfb;}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-variable,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id{color:#6cb6ff;}.hljs-regexp,.hljs-string,.hljs-meta .hljs-string{color:#96d0ff;}.hljs-built_in,.hljs-symbol{color:#f69d50;}.hljs-comment,.hljs-code,.hljs-formula{color:#768390;}.hljs-name,.hljs-quote,.hljs-selector-tag,.hljs-selector-pseudo{color:#8ddb8c;}.hljs-subst{color:#adbac7;}.hljs-section{color:#316dca;font-weight:bold;}.hljs-bullet{color:#eac55f;}.hljs-emphasis{color:#adbac7;font-style:italic;}.hljs-strong{color:#adbac7;font-weight:bold;}.hljs-addition{color:#b4f1b4;background-color:#1b4721;}.hljs-deletion{color:#ffd8d3;background-color:#78191b;}</style><style data-emotion="rpcss 9vhaby">.rpcss-9vhaby{background-color:var(--gradient-red-bottom);background-image:linear-gradient(to bottom right, var(--gradient-red-top), var(--gradient-red-bottom));}</style><header class="rpcss-9vhaby" style="background-image:linear-gradient(to bottom right, hsl(44, 100%, 35%), hsl(36, 100%, 30%))"><style data-emotion="rpcss 1qqk0tr">.rpcss-1qqk0tr{padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);}</style><div class="rpcss-1qqk0tr"><style data-emotion="rpcss qx7dny">.rpcss-qx7dny{width:100%;max-width:1024px;margin:0 auto;padding:0 10px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="rpcss-qx7dny"><style data-emotion="rpcss 7s9om2">.rpcss-7s9om2{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding:20px 0 50px;}</style><div class="rpcss-7s9om2"><style data-emotion="rpcss gdpa5c">.rpcss-gdpa5c{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-gdpa5c" href="/"><style data-emotion="rpcss 1lm4738">.rpcss-1lm4738{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-text-decoration:none;text-decoration:none;padding-bottom:10px;}</style><div class="rpcss-1lm4738"><style data-emotion="rpcss 13o7eu2">.rpcss-13o7eu2{display:block;}</style><svg class="rpcss-13o7eu2" height="36px" width="36px" viewBox="0 0 36 36"><defs><linearGradient id="PutainDeCodeLogoGradient" x1="50%" x2="50%" y1="0%" y2="127.223881%"><stop offset="0%" stop-color="#E41D57"></stop><stop offset="100%" stop-color="#C60000"></stop></linearGradient></defs><circle cx="18" cy="18" fill="url(#PutainDeCodeLogoGradient)" r="17" stroke="#FFFFFF" stroke-width="2"></circle><polygon fill="#FFFFFF" points="15.9033203 18.2246094 15.9033203 18.3710938 11.2304688 20.5317383 11.2304688 22.8095703 18.0566406 19.184082 18.0566406 17.4116211 11.2304688 13.7788086 11.2304688 16.0639648"></polygon><rect height="14" width="2" fill="#FFFFFF" x="22" y="11"><animate attributeName="opacity" begin="100ms" calcMode="discrete" dur="2s" repeatCount="indefinite" values="1;0"></animate></rect></svg><style data-emotion="rpcss 4cf197">.rpcss-4cf197{width:10px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-4cf197"></div><style data-emotion="rpcss u5k24">.rpcss-u5k24{font-size:22px;color:#fff;font-weight:800;}</style><div aria-level="2" class="rpcss-u5k24" role="heading">Putain de code !</div></div><style data-emotion="rpcss 1nyebg4">.rpcss-1nyebg4{font-size:14px;color:rgba(255, 255, 255, 0.8);text-align:center;}</style><div class="rpcss-1nyebg4">Blog participatif de la communauté dev</div></a></div></div></div></header><style data-emotion="rpcss a4ric9">.rpcss-a4ric9{background-color:var(--page-slightly-accented-background-color);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="rpcss-a4ric9"><style data-emotion="rpcss oeugsb">.rpcss-oeugsb{-webkit-animation:500ms ease-out animation-zx73cm;animation:500ms ease-out animation-zx73cm;}</style><div class="rpcss-oeugsb"><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 1qc2bam">.rpcss-1qc2bam{font-size:42px;font-weight:800;text-align:center;padding-top:40px;line-height:1.2;margin:0;}</style><h1 class="rpcss-1qc2bam">Quelques retours sur React et le rendu serveur</h1><style data-emotion="rpcss obg2kr">.rpcss-obg2kr{font-size:16px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding-top:10px;padding-bottom:40px;color:var(--page-text-color);-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-obg2kr" href="https://github.com/lionelB"><style data-emotion="rpcss uco8i7">.rpcss-uco8i7{width:32px;height:32px;border-radius:100%;margin-right:10px;}</style><img class="rpcss-uco8i7" alt="lionelB" src="https://avatars.githubusercontent.com/lionelB?size=64"/><div>lionelB<!-- --> <!-- -->•<!-- --> <!-- -->2015/02/23</div></a><style data-emotion="rpcss 15kxmi0">.rpcss-15kxmi0{max-width:640px;width:100%;font-size:18px;margin:0 auto;line-height:1.7;}.rpcss-15kxmi0 h2,.rpcss-15kxmi0 h3,.rpcss-15kxmi0 h4,.rpcss-15kxmi0 h5,.rpcss-15kxmi0 h6{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;font-weight:800;line-height:1.2;}.rpcss-15kxmi0 img{max-width:100%;background-color:rgba(255, 255, 255, 0.75);}.rpcss-15kxmi0 code{font-size:0.9em;font-family:PragmataPro,SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;line-height:1;background-color:var(--code-background-color);margin:0 0.2em;}.rpcss-15kxmi0 pre{padding:10px;overflow-x:auto;font-size:14px;border-radius:10px;border:2px solid var(--one-percent-contrast-color);-webkit-overflow-scrolling:touch;}.rpcss-15kxmi0 pre code{font-size:14px;background-color:transparent;margin:0;}.rpcss-15kxmi0 blockquote{padding-left:20px;margin:0;font-size:16px;border-left:3px solid var(--one-percent-contrast-color);font-style:italic;}.rpcss-15kxmi0 table{width:100%;text-align:center;}.rpcss-15kxmi0 figure{padding:20px 0;}.rpcss-15kxmi0 figcaption{text-align:center;}.rpcss-15kxmi0 a{word-wrap:break-word;}.rpcss-15kxmi0 table thead th{background-color:var(--page-accented-background-color);padding:10px 0;}</style><div class="rpcss-15kxmi0"><p>On entend souvent parler d'applications JavaScript isomorphiques, et même si le
nom ne <a href="https://news.ycombinator.com/item?id=8237449">fait</a>
<a href="https://twitter.com/wycats/status/566857009836724224">pas</a>
<a href="https://medium.com/the-thinkmill/making-the-case-for-progressive-javascript-a98dfa82b9d7">l'unanimité</a>,
ce qu'il y a derrière, le concept de <em>server side rendered JavaScript</em> est en
passe de devenir un sujet plutôt tendance pour 2015 grâce à la monté en
puissance de <a href="http://facebook.github.io/react/">Reactjs</a>. Faire du rendu
d'application JavaScript coté serveur permet de réconcilier enfin le développeur
de <em>Single Page App</em> (SPA) avec l’amélioration progressive, l'accessibilité et
le SEO ; quoique Google comme les lecteurs d'écran ont plutôt bien évolué
sur ce point. L'autre avantage non négligeable à mon sens, est qu'on améliore
les performances perçues par rapport à une SPA classique puisque :</p>
<ul>
<li>On supprime une requête <em>ajax</em> au démarrage pour récupérer le contenu initial.</li>
<li>On améliore la vitesse de rendu initial de page.</li>
<li>On bénéficie de la fluidité de navigation d'une SPA.</li>
</ul>
<p>Pour plus d'info sur les avantages, il y a
<a href="http://tech.m6web.fr/isomorphic-single-page-app-parfaite-react-flux/">cet article</a>
sur le blog de M6Tech.</p>
<p>Afin de me familiariser avec React et son écosystème, rien de mieux que mettre
les mains dedans ! C'est un peu pour toutes ces raisons que j'ai décidé de
l'utiliser pour mon site web (un site statique).</p>
<p><strong>Inutile et donc totalement justifié pour le développeur que je suis</strong>. Une des
premières briques que j'ai mises en place a été le routeur.</p>
<p>##react-router Pour une fois dans la communauté JavaScript, il y a une
bibliothèque de référence et c'est celle là :
<a href="https://github.com/rackt/react-router">react-router</a>. Le routeur est fortement
inspiré par celui d'Ember au sens où les URL et leurs routes sont au cœur du
dispositif. Le routeur se présente sous forme de composant React et ça donne ça.</p>
<pre><code class="hljs language-jsx"><span class="hljs-comment">//routes.js</span>

<span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react&quot;</span>);
<span class="hljs-keyword">var</span> Router = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react-router&quot;</span>);

<span class="hljs-keyword">var</span> Route = Router.Route;
<span class="hljs-keyword">var</span> DefaultRoute = Router.DefaultRoute;
<span class="hljs-keyword">var</span> NotFoundRoute = Router.NotFoundRoute;

<span class="hljs-keyword">var</span> App = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./app&quot;</span>);
<span class="hljs-keyword">var</span> Home = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./home/homePage&quot;</span>);
<span class="hljs-keyword">var</span> Project = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./project/projectPage&quot;</span>);
<span class="hljs-keyword">var</span> NotFound = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./notFound&quot;</span>);

<span class="hljs-keyword">var</span> routes = (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">handler</span>=<span class="hljs-string">{App}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">DefaultRoute</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;index&quot;</span> <span class="hljs-attr">handler</span>=<span class="hljs-string">{Home}</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;project&quot;</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/projects/:url&quot;</span> <span class="hljs-attr">handler</span>=<span class="hljs-string">{Project}</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">NotFoundRoute</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;404&quot;</span> <span class="hljs-attr">handler</span>=<span class="hljs-string">{NotFound}</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span>
);

<span class="hljs-built_in">module</span>.exports = routes;
</code></pre>
<p>À mon sens, l'aspect déclaratif apporte de la clarté et améliore la
compréhension du système. On voit rapidement quel composant est utilisé en
fonction de l'URL. L'autre avantage du déclaratif, c'est qu'il permet de manière
assez simple, d'imbriquer les routes en imbriquant les nœuds <code>&lt;Route&gt;</code>.</p>
<p>En plus des composants, on a aussi à disposition des <em>mixins</em> pour naviguer
programmatiquement ou accéder aux infos du routeur (chemin, paramètres, ...)</p>
<p>Et le gros plus de cette bibliothèque : elle peut aussi s'utiliser coté serveur,
pour la génération des vues et éviter ainsi de dupliquer du code puisqu'on va
pouvoir carrément utiliser tel quel le fichier précédent. Plutôt cool !
Voici un exemple de <em>middleware</em> pour faire marcher ça dans Express :</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react&quot;</span>);
<span class="hljs-keyword">var</span> Router = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react-router&quot;</span>);

<span class="hljs-comment">// notre fichier routes.js</span>
<span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./src/routes&quot;</span>);
<span class="hljs-comment">// notre template de page html</span>
<span class="hljs-keyword">var</span> Html = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./src/html&quot;</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reactView</span>(<span class="hljs-params">req, res, next</span>) </span>{
  Router.run(routes, req.url, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Handler, state</span>) </span>{
    <span class="hljs-comment">// on récupère les données pour cette vue en fonction de la requête.</span>
    <span class="hljs-keyword">var</span> data = getViewData(req);

    <span class="hljs-comment">// on génère la soupe au tag avec nos données dedans</span>
    <span class="hljs-keyword">var</span> markup = React.renderToString(React.createElement(Handler), data);

    <span class="hljs-comment">// on utilise React comme moteur de template</span>
    <span class="hljs-keyword">var</span> HtmlElement = React.createElement(Html, { <span class="hljs-attr">markup</span>: markup });
    res.send(<span class="hljs-string">&quot;&lt;!DOCTYPE html&gt;&quot;</span> + React.renderToStaticMarkup(HtmlElement));
  });
}
</code></pre>
<p>Et voici le composant <code>Html.jsx</code> que l'on utilise comme <em>template</em> pour notre
page principale.</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react&quot;</span>);

<span class="hljs-keyword">var</span> Html = React.createClass({
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charSet</span>=<span class="hljs-string">&quot;utf-8&quot;</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Mon site perso<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/app.js&quot;</span> /&gt;</span><span class="handlebars"><span class="xml">
        <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;react-app&quot;</span>
            <span class="hljs-attr">dangerouslySetInnerHTML</span>=</span></span><span class="hljs-template-variable">{{ <span class="hljs-name">__html:</span> this.props.markup }}</span><span class="xml"><span class="hljs-tag">
          /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span></span></span>
    );
  },
});

<span class="hljs-built_in">module</span>.exports = Html;
</code></pre>
<p>Une fois que le code HTML a été généré
via<code>React.renderToString(React.createElement(Handler), data);</code>, on pourrait
utiliser n'importe quel moteur de template (lodash.template, handlebars, ejs,
jade, PHP...) pour générer le HTML de la page à renvoyer. Dans un souci de
rationalisation des outils, j'ai préféré utiliser React.</p>
<p>Vous avez dû vous apercevoir qu'on utilise 2 méthodes différentes pour générer
du HTML avec React :</p>
<ul>
<li><code>React.renderToString(React.createElement(Handler), data);</code></li>
<li><code>React.renderToStaticMarkup(React.createElement(Handler), data);</code></li>
</ul>
<p>La différence entre les deux méthodes est simple. Dans la première, React annote
les nœuds HTML avec des <code>data-reactid</code> dans le but de pouvoir ensuite reprendre
la main lorsque votre l'application s'exécutera dans le navigateur. De cette
manière, React sait que vous l'initialisez avec un contenu généré depuis le
serveur. Et si il détecte une différence entre le code existant et celui qu'il
génère, vous aurez droit à un
<a href="https://github.com/facebook/react/blob/2aeb8a2a6beb00617a4217f7f8284924fa2ad819/src/browser/ui/__tests__/ReactRenderDocument-test.js#L205-L215">petit warning</a>.
La deuxième méthode permet de générer du code HTML sans annotations, comme
n'importe quel moteur de <em>template</em>.</p>
<p>Les plus attentifs auront remarqué qu'on passe les données initiales lors de la
création de l'application via des <em>props</em> React. Quid de l'utilisation de flux
dans tout ça ?</p>
<h2>Flux et le rendu serveur</h2>
<p>Avec <a href="http://facebook.github.io/flux/">Flux</a>, ce sont les stores qui
maintiennent l'état de notre application. Si l'on ne veut pas afficher notre
application sans aucune données, nous allons devoir préalablement peupler nos
stores avant d'appeler <code>React.renderToString()</code>.</p>
<p>Là où ça se corse un peu, c'est qu'il va falloir remplir nos stores avant de
démarrer notre application sous peine de voir le message d'alerte dont je
parlais plus haut. Le plus simple alors est de passer ces données au moteur de
template, en plus du markup (par exemple sous la forme d'un nœud
<code>&lt;script type=&quot;application/json&quot;&gt;JSON DATA&lt;/script&gt;</code>. Il ne reste plus qu'a
récupérer ces données avant d’appeler
<code>React.render( Application, document.getElementById(&quot;react-app&quot;))</code></p>
<p>Par exemple :</p>
<pre><code class="hljs language-javascript"><span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">&quot;DOMContentLoaded&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
  <span class="hljs-comment">// getData() va récuperer et parser le contenu du tag script</span>
  <span class="hljs-comment">// qui contient nos données</span>
  <span class="hljs-keyword">var</span> storeData = getData();

  <span class="hljs-comment">// on déclenche une actions</span>
  actions.init(storeData);

  <span class="hljs-comment">// on lance le rendu</span>
  React.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;react-app&quot;</span>));
});
</code></pre>
<h2>Le mot de la fin</h2>
<p>Penser son application React pour qu'elle puisse être rendue coté serveur
introduit de nouvelles problématiques, notamment avec l'ajout du <em>pattern</em> Flux.
En fonction des pages que l'on souhaite afficher, on devra initialiser
différents <em>stores</em>. À nous de déterminer, en fonction de l'URL et du composant
à afficher, lequel initialiser, et cela, que l'on soit sur le client ou le
serveur. De la même manière, il faudra être capable de charger nos données,
indépendamment de l'environnement d’exécution (coucou XHR).</p>
<p>Un début de réponse se trouve dans les exemples fournis avec react-router.
L'idée est de passer par une propriété <code>statics</code> lors de la création des
composants React qui seront associés à une <code>&lt;Route/&gt;</code>.</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">var</span> ProjectPage = React.createClass({
  <span class="hljs-attr">statics</span>: {
    <span class="hljs-attr">fetchData</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>)</span>{
      <span class="hljs-keyword">return</span> api.getPageData(params.url)
        .then( actions.initProject)
        .catch( actions.loadProjectError);
    }
  }
 ...
 });
</code></pre>
<p>Dans ce bloc <code>statics</code>, on définit une fonction qui servira à récupérer les
données pour ce composant mais on pourrait très bien imaginer retourner la liste
d'actions à lancer ou encore les <em>stores</em> à initialiser voire même un
descripteur des données nécessaires à la vue
(<a href="https://www.youtube.com/watch?v=9sc8Pyc51uU">cf Relay / GraphQL</a>)</p>
<p>Ensuite, lorsque le callback fourni à <code>Router.run()</code> est appelé, il suffit de
parcourir les <em>Handler</em> pour récupérer les informations contenues dans les blocs
<code>statics</code>, les traiter et enfin faire <code>React.render()</code>.</p>
<pre><code class="hljs language-Javascript"><span class="hljs-comment">// On renvoie une promesse qui sera résolue lorsque que toutes les données démandées via fetchData seront reçues.</span>
Router.run(routes, Router.HistoryLocation, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Handler, state</span>) </span>{
  <span class="hljs-keyword">var</span> p = <span class="hljs-built_in">Promise</span>.all(state.routes
    .filter(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> route.handler.fetchData)  <span class="hljs-comment">// définit fetchData</span>
    .map(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> route.handler.fetchData(state.params);
    })
  );
  p.then( <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> {
    React.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Handler</span> {<span class="hljs-attr">...state</span>} /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;react-app&quot;</span>))
  });
});
</code></pre>
<p>Le principe est simple et peut être facilement encapsulé dans un module pour
être partagé entre le client et le serveur. J'espère que cet article vous a
permis d'appréhender un peu mieux le rendu coté serveur d'une application React.
N'hésitez pas à laisser des commentaires si vous avez des questions où si vous
souhaitez partager vos expériences dans ce domaine.</p>
<p>Et quelques liens vidéo des sessions de la #reactjsconf :</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=XZfvW1a8Xac">React.js Conf 2015 - react-router increases your productivity </a></li>
<li><a href="https://www.youtube.com/watch?v=z5e7kWSHWTg">React.js Conf 2015 - Hype!</a> : un
aperçu des possibilités de react-router</li>
</ul>
</div><style data-emotion="rpcss unyj6i">.rpcss-unyj6i{max-width:640px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;margin:20px auto;padding:20px;background-color:var(--page-background-color);border-radius:10px;box-shadow:0 15px 15px -5px rgba(0, 0, 0, 0.2);}@media (max-width: 540px){.rpcss-unyj6i{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-unyj6i"><style data-emotion="rpcss ty7r4z">.rpcss-ty7r4z{font-weight:800;}</style><div class="rpcss-ty7r4z">Vous avez aimé cet article?</div><style data-emotion="rpcss klacsp">.rpcss-klacsp{width:0;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-klacsp"></div><style data-emotion="rpcss 1pkr03v">.rpcss-1pkr03v{background-color:#00aced;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:800;}.rpcss-1pkr03v:active{opacity:0.5;}</style><a class="rpcss-1pkr03v" href="https://www.twitter.com/intent/tweet?text=Quelques%20retours%20sur%20React%20et%20le%20rendu%20serveur%20sur%20%40PutainDeCode%20https%3A%2F%2Fputaindecode.io%2Farticles%2Fquelques-retours-sur-react-et-le-rendu-serveur" target="_blank">Le partager sur Twitter</a></div><style data-emotion="rpcss x4iqxe">.rpcss-x4iqxe{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;text-align:center;padding:20px;}</style><div class="rpcss-x4iqxe"><style data-emotion="rpcss gein6x">.rpcss-gein6x{font-size:20px;-webkit-text-decoration:none;text-decoration:none;color:#1E49B5;}</style><a class="rpcss-gein6x" href="/articles">← Articles</a></div><style data-emotion="rpcss 8bodgl">.rpcss-8bodgl{max-width:640px;width:100%;margin:0 auto;padding:20px 0;}</style><div class="rpcss-8bodgl" id="disqus_thread"></div></div></div></div></div><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 1vau6rl">.rpcss-1vau6rl{margin:20px 0;background-color:var(--page-accented-background-color);border-radius:10px;padding:20px;}</style><div class="rpcss-1vau6rl"><style data-emotion="rpcss 1gz1i1h">.rpcss-1gz1i1h{font-size:32px;font-weight:800;margin-bottom:20px;text-align:center;}</style><div aria-level="2" class="rpcss-1gz1i1h" role="heading">Ne rien rater</div><style data-emotion="rpcss 1wbispj">.rpcss-1wbispj{font-size:18px;margin-bottom:10px;text-align:center;}</style><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur les réseaux</div><style data-emotion="rpcss 1hyoz7m">.rpcss-1hyoz7m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}</style><div class="rpcss-1hyoz7m"><a href="https://twitter.com/PutainDeCode"><img alt="Twitter" height="48" src="/public/images/website/twitter.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://facebook.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/facebook.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://github.com/putaindecode"><img alt="Facebook" height="48" src="/public/images/website/github.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://itunes.apple.com/fr/podcast/putain-de-code-!/id1185311825"><img alt="Apple Podcast" height="48" src="/public/images/website/apple-podcast.svg" width="48"/></a><div class="rpcss-4cf197"></div><a href="https://soundcloud.com/putaindecode"><img alt="Soundcloud" height="48" src="/public/images/website/soundcloud.svg" width="48"/></a></div><div aria-level="3" class="rpcss-1wbispj" role="heading">Sur le chat</div><div class="rpcss-1hyoz7m"><a href="https://discord.gg/jtbGNNc"><img alt="Discord" height="48" src="/public/images/website/discord.svg" width="48"/></a></div></div></div></div><style data-emotion="rpcss zs8kw7">.rpcss-zs8kw7{background-color:#222;padding:20px 0;}</style><footer class="rpcss-zs8kw7"><div class="rpcss-1qqk0tr"><div class="rpcss-qx7dny"><style data-emotion="rpcss 79elbk">.rpcss-79elbk{position:relative;}</style><div class="rpcss-79elbk"><style data-emotion="rpcss 1hle0ni">.rpcss-1hle0ni{position:absolute;left:0;top:50%;color:#fff;-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1hle0ni" href="/api/articles/feeds/desc/feed.xml"><style data-emotion="rpcss lvyu5j">.rpcss-lvyu5j{margin-right:10px;}</style><img class="rpcss-lvyu5j" alt="Flux RSS" height="16" src="/public/images/website/rss-feed.svg" width="16"/><style data-emotion="rpcss um3i31">@media (max-width: 400px){.rpcss-um3i31{display:none;}}</style><div class="rpcss-um3i31">Flux RSS</div></a><style data-emotion="rpcss 12cp4l7">.rpcss-12cp4l7{color:rgba(255, 255, 255, 0.5);text-align:center;font-size:14px;}</style><div class="rpcss-12cp4l7">© 2021 Putain de code !</div><style data-emotion="rpcss 1w98uy3">.rpcss-1w98uy3{position:absolute;right:0;top:50%;color:#fff;-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);-webkit-text-decoration:none;text-decoration:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><a class="rpcss-1w98uy3" href="https://github.com/putaindecode/putaindecode.io">GitHub</a></div></div></div></footer></div><script id="initialData" type="text/data">{"lists":{"RE_PRIVATE_NONE":true},"items":{"k":"articles","v":{"k":"quelques-retours-sur-react-et-le-rendu-serveur","v":{"_0":{"TAG":0,"_0":{"slug":"quelques-retours-sur-react-et-le-rendu-serveur","filename":"2015-02-23-quelques-retours-sur-react-et-le-rendu-serveur","title":"Quelques retours sur React et le rendu serveur","date":"Mon, 23 Feb 2015 00:00:00 GMT","draft":false,"meta":{"date":"2015-02-23T00:00:00.000Z","title":"Quelques retours sur React et le rendu serveur","author":"lionelB","oldSlug":"js/react/cote-serveur","slug":"quelques-retours-sur-react-et-le-rendu-serveur"},"body":"<p>On entend souvent parler d'applications JavaScript isomorphiques, et même si le\nnom ne <a href=\"https://news.ycombinator.com/item?id=8237449\">fait</a>\n<a href=\"https://twitter.com/wycats/status/566857009836724224\">pas</a>\n<a href=\"https://medium.com/the-thinkmill/making-the-case-for-progressive-javascript-a98dfa82b9d7\">l'unanimité</a>,\nce qu'il y a derrière, le concept de <em>server side rendered JavaScript</em> est en\npasse de devenir un sujet plutôt tendance pour 2015 grâce à la monté en\npuissance de <a href=\"http://facebook.github.io/react/\">Reactjs</a>. Faire du rendu\nd'application JavaScript coté serveur permet de réconcilier enfin le développeur\nde <em>Single Page App</em> (SPA) avec l’amélioration progressive, l'accessibilité et\nle SEO ; quoique Google comme les lecteurs d'écran ont plutôt bien évolué\nsur ce point. L'autre avantage non négligeable à mon sens, est qu'on améliore\nles performances perçues par rapport à une SPA classique puisque :</p>\n<ul>\n<li>On supprime une requête <em>ajax</em> au démarrage pour récupérer le contenu initial.</li>\n<li>On améliore la vitesse de rendu initial de page.</li>\n<li>On bénéficie de la fluidité de navigation d'une SPA.</li>\n</ul>\n<p>Pour plus d'info sur les avantages, il y a\n<a href=\"http://tech.m6web.fr/isomorphic-single-page-app-parfaite-react-flux/\">cet article</a>\nsur le blog de M6Tech.</p>\n<p>Afin de me familiariser avec React et son écosystème, rien de mieux que mettre\nles mains dedans ! C'est un peu pour toutes ces raisons que j'ai décidé de\nl'utiliser pour mon site web (un site statique).</p>\n<p><strong>Inutile et donc totalement justifié pour le développeur que je suis</strong>. Une des\npremières briques que j'ai mises en place a été le routeur.</p>\n<p>##react-router Pour une fois dans la communauté JavaScript, il y a une\nbibliothèque de référence et c'est celle là :\n<a href=\"https://github.com/rackt/react-router\">react-router</a>. Le routeur est fortement\ninspiré par celui d'Ember au sens où les URL et leurs routes sont au cœur du\ndispositif. Le routeur se présente sous forme de composant React et ça donne ça.</p>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-comment\">//routes.js</span>\n\n<span class=\"hljs-keyword\">var</span> React = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;react&quot;</span>);\n<span class=\"hljs-keyword\">var</span> Router = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;react-router&quot;</span>);\n\n<span class=\"hljs-keyword\">var</span> Route = Router.Route;\n<span class=\"hljs-keyword\">var</span> DefaultRoute = Router.DefaultRoute;\n<span class=\"hljs-keyword\">var</span> NotFoundRoute = Router.NotFoundRoute;\n\n<span class=\"hljs-keyword\">var</span> App = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;./app&quot;</span>);\n<span class=\"hljs-keyword\">var</span> Home = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;./home/homePage&quot;</span>);\n<span class=\"hljs-keyword\">var</span> Project = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;./project/projectPage&quot;</span>);\n<span class=\"hljs-keyword\">var</span> NotFound = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;./notFound&quot;</span>);\n\n<span class=\"hljs-keyword\">var</span> routes = (\n  <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Route</span> <span class=\"hljs-attr\">path</span>=<span class=\"hljs-string\">&quot;/&quot;</span> <span class=\"hljs-attr\">handler</span>=<span class=\"hljs-string\">{App}</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">DefaultRoute</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;index&quot;</span> <span class=\"hljs-attr\">handler</span>=<span class=\"hljs-string\">{Home}</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Route</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;project&quot;</span> <span class=\"hljs-attr\">path</span>=<span class=\"hljs-string\">&quot;/projects/:url&quot;</span> <span class=\"hljs-attr\">handler</span>=<span class=\"hljs-string\">{Project}</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">NotFoundRoute</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;404&quot;</span> <span class=\"hljs-attr\">handler</span>=<span class=\"hljs-string\">{NotFound}</span> /&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Route</span>&gt;</span></span>\n);\n\n<span class=\"hljs-built_in\">module</span>.exports = routes;\n</code></pre>\n<p>À mon sens, l'aspect déclaratif apporte de la clarté et améliore la\ncompréhension du système. On voit rapidement quel composant est utilisé en\nfonction de l'URL. L'autre avantage du déclaratif, c'est qu'il permet de manière\nassez simple, d'imbriquer les routes en imbriquant les nœuds <code>&lt;Route&gt;</code>.</p>\n<p>En plus des composants, on a aussi à disposition des <em>mixins</em> pour naviguer\nprogrammatiquement ou accéder aux infos du routeur (chemin, paramètres, ...)</p>\n<p>Et le gros plus de cette bibliothèque : elle peut aussi s'utiliser coté serveur,\npour la génération des vues et éviter ainsi de dupliquer du code puisqu'on va\npouvoir carrément utiliser tel quel le fichier précédent. Plutôt cool !\nVoici un exemple de <em>middleware</em> pour faire marcher ça dans Express :</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">var</span> React = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;react&quot;</span>);\n<span class=\"hljs-keyword\">var</span> Router = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;react-router&quot;</span>);\n\n<span class=\"hljs-comment\">// notre fichier routes.js</span>\n<span class=\"hljs-keyword\">var</span> routes = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;./src/routes&quot;</span>);\n<span class=\"hljs-comment\">// notre template de page html</span>\n<span class=\"hljs-keyword\">var</span> Html = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;./src/html&quot;</span>);\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">reactView</span>(<span class=\"hljs-params\">req, res, next</span>) </span>{\n  Router.run(routes, req.url, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">Handler, state</span>) </span>{\n    <span class=\"hljs-comment\">// on récupère les données pour cette vue en fonction de la requête.</span>\n    <span class=\"hljs-keyword\">var</span> data = getViewData(req);\n\n    <span class=\"hljs-comment\">// on génère la soupe au tag avec nos données dedans</span>\n    <span class=\"hljs-keyword\">var</span> markup = React.renderToString(React.createElement(Handler), data);\n\n    <span class=\"hljs-comment\">// on utilise React comme moteur de template</span>\n    <span class=\"hljs-keyword\">var</span> HtmlElement = React.createElement(Html, { <span class=\"hljs-attr\">markup</span>: markup });\n    res.send(<span class=\"hljs-string\">&quot;&lt;!DOCTYPE html&gt;&quot;</span> + React.renderToStaticMarkup(HtmlElement));\n  });\n}\n</code></pre>\n<p>Et voici le composant <code>Html.jsx</code> que l'on utilise comme <em>template</em> pour notre\npage principale.</p>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-keyword\">var</span> React = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;react&quot;</span>);\n\n<span class=\"hljs-keyword\">var</span> Html = React.createClass({\n  <span class=\"hljs-attr\">render</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>{\n    <span class=\"hljs-keyword\">return</span> (\n      <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span>\n          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">charSet</span>=<span class=\"hljs-string\">&quot;utf-8&quot;</span> /&gt;</span>\n          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Mon site perso<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;/js/app.js&quot;</span> /&gt;</span><span class=\"handlebars\"><span class=\"xml\">\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>\n            <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;react-app&quot;</span>\n            <span class=\"hljs-attr\">dangerouslySetInnerHTML</span>=</span></span><span class=\"hljs-template-variable\">{{ <span class=\"hljs-name\">__html:</span> this.props.markup }}</span><span class=\"xml\"><span class=\"hljs-tag\">\n          /&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span></span></span></span>\n    );\n  },\n});\n\n<span class=\"hljs-built_in\">module</span>.exports = Html;\n</code></pre>\n<p>Une fois que le code HTML a été généré\nvia<code>React.renderToString(React.createElement(Handler), data);</code>, on pourrait\nutiliser n'importe quel moteur de template (lodash.template, handlebars, ejs,\njade, PHP...) pour générer le HTML de la page à renvoyer. Dans un souci de\nrationalisation des outils, j'ai préféré utiliser React.</p>\n<p>Vous avez dû vous apercevoir qu'on utilise 2 méthodes différentes pour générer\ndu HTML avec React :</p>\n<ul>\n<li><code>React.renderToString(React.createElement(Handler), data);</code></li>\n<li><code>React.renderToStaticMarkup(React.createElement(Handler), data);</code></li>\n</ul>\n<p>La différence entre les deux méthodes est simple. Dans la première, React annote\nles nœuds HTML avec des <code>data-reactid</code> dans le but de pouvoir ensuite reprendre\nla main lorsque votre l'application s'exécutera dans le navigateur. De cette\nmanière, React sait que vous l'initialisez avec un contenu généré depuis le\nserveur. Et si il détecte une différence entre le code existant et celui qu'il\ngénère, vous aurez droit à un\n<a href=\"https://github.com/facebook/react/blob/2aeb8a2a6beb00617a4217f7f8284924fa2ad819/src/browser/ui/__tests__/ReactRenderDocument-test.js#L205-L215\">petit warning</a>.\nLa deuxième méthode permet de générer du code HTML sans annotations, comme\nn'importe quel moteur de <em>template</em>.</p>\n<p>Les plus attentifs auront remarqué qu'on passe les données initiales lors de la\ncréation de l'application via des <em>props</em> React. Quid de l'utilisation de flux\ndans tout ça ?</p>\n<h2>Flux et le rendu serveur</h2>\n<p>Avec <a href=\"http://facebook.github.io/flux/\">Flux</a>, ce sont les stores qui\nmaintiennent l'état de notre application. Si l'on ne veut pas afficher notre\napplication sans aucune données, nous allons devoir préalablement peupler nos\nstores avant d'appeler <code>React.renderToString()</code>.</p>\n<p>Là où ça se corse un peu, c'est qu'il va falloir remplir nos stores avant de\ndémarrer notre application sous peine de voir le message d'alerte dont je\nparlais plus haut. Le plus simple alors est de passer ces données au moteur de\ntemplate, en plus du markup (par exemple sous la forme d'un nœud\n<code>&lt;script type=&quot;application/json&quot;&gt;JSON DATA&lt;/script&gt;</code>. Il ne reste plus qu'a\nrécupérer ces données avant d’appeler\n<code>React.render( Application, document.getElementById(&quot;react-app&quot;))</code></p>\n<p>Par exemple :</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-built_in\">document</span>.addEventListener(<span class=\"hljs-string\">&quot;DOMContentLoaded&quot;</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">event</span>) </span>{\n  <span class=\"hljs-comment\">// getData() va récuperer et parser le contenu du tag script</span>\n  <span class=\"hljs-comment\">// qui contient nos données</span>\n  <span class=\"hljs-keyword\">var</span> storeData = getData();\n\n  <span class=\"hljs-comment\">// on déclenche une actions</span>\n  actions.init(storeData);\n\n  <span class=\"hljs-comment\">// on lance le rendu</span>\n  React.render(<span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">App</span> /&gt;</span></span>, <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">&quot;react-app&quot;</span>));\n});\n</code></pre>\n<h2>Le mot de la fin</h2>\n<p>Penser son application React pour qu'elle puisse être rendue coté serveur\nintroduit de nouvelles problématiques, notamment avec l'ajout du <em>pattern</em> Flux.\nEn fonction des pages que l'on souhaite afficher, on devra initialiser\ndifférents <em>stores</em>. À nous de déterminer, en fonction de l'URL et du composant\nà afficher, lequel initialiser, et cela, que l'on soit sur le client ou le\nserveur. De la même manière, il faudra être capable de charger nos données,\nindépendamment de l'environnement d’exécution (coucou XHR).</p>\n<p>Un début de réponse se trouve dans les exemples fournis avec react-router.\nL'idée est de passer par une propriété <code>statics</code> lors de la création des\ncomposants React qui seront associés à une <code>&lt;Route/&gt;</code>.</p>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-keyword\">var</span> ProjectPage = React.createClass({\n  <span class=\"hljs-attr\">statics</span>: {\n    <span class=\"hljs-attr\">fetchData</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">params</span>)</span>{\n      <span class=\"hljs-keyword\">return</span> api.getPageData(params.url)\n        .then( actions.initProject)\n        .catch( actions.loadProjectError);\n    }\n  }\n ...\n });\n</code></pre>\n<p>Dans ce bloc <code>statics</code>, on définit une fonction qui servira à récupérer les\ndonnées pour ce composant mais on pourrait très bien imaginer retourner la liste\nd'actions à lancer ou encore les <em>stores</em> à initialiser voire même un\ndescripteur des données nécessaires à la vue\n(<a href=\"https://www.youtube.com/watch?v=9sc8Pyc51uU\">cf Relay / GraphQL</a>)</p>\n<p>Ensuite, lorsque le callback fourni à <code>Router.run()</code> est appelé, il suffit de\nparcourir les <em>Handler</em> pour récupérer les informations contenues dans les blocs\n<code>statics</code>, les traiter et enfin faire <code>React.render()</code>.</p>\n<pre><code class=\"hljs language-Javascript\"><span class=\"hljs-comment\">// On renvoie une promesse qui sera résolue lorsque que toutes les données démandées via fetchData seront reçues.</span>\nRouter.run(routes, Router.HistoryLocation, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">Handler, state</span>) </span>{\n  <span class=\"hljs-keyword\">var</span> p = <span class=\"hljs-built_in\">Promise</span>.all(state.routes\n    .filter(<span class=\"hljs-function\"><span class=\"hljs-params\">route</span> =&gt;</span> route.handler.fetchData)  <span class=\"hljs-comment\">// définit fetchData</span>\n    .map(<span class=\"hljs-function\"><span class=\"hljs-params\">route</span> =&gt;</span> {\n      <span class=\"hljs-keyword\">return</span> route.handler.fetchData(state.params);\n    })\n  );\n  p.then( <span class=\"hljs-function\"><span class=\"hljs-params\">x</span> =&gt;</span> {\n    React.render(<span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Handler</span> {<span class=\"hljs-attr\">...state</span>} /&gt;</span></span>, <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">&quot;react-app&quot;</span>))\n  });\n});\n</code></pre>\n<p>Le principe est simple et peut être facilement encapsulé dans un module pour\nêtre partagé entre le client et le serveur. J'espère que cet article vous a\npermis d'appréhender un peu mieux le rendu coté serveur d'une application React.\nN'hésitez pas à laisser des commentaires si vous avez des questions où si vous\nsouhaitez partager vos expériences dans ce domaine.</p>\n<p>Et quelques liens vidéo des sessions de la #reactjsconf :</p>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=XZfvW1a8Xac\">React.js Conf 2015 - react-router increases your productivity </a></li>\n<li><a href=\"https://www.youtube.com/watch?v=z5e7kWSHWTg\">React.js Conf 2015 - Hype!</a> : un\naperçu des possibilités de react-router</li>\n</ul>\n"}}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"listsRequests":{"data":{"RE_PRIVATE_NONE":true}},"itemsRequests":{"data":{"RE_PRIVATE_NONE":true}}}</script><head><script defer="defer" src="/public/main.56c69761a03eb0112696.js"></script></head></html>