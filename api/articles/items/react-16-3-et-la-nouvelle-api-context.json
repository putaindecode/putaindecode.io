{"slug":"react-16-3-et-la-nouvelle-api-context","filename":"2018-06-21-react-16-3-et-la-nouvelle-api-context","title":"React 16.3 et la nouvelle API Context","date":"Thu, 21 Jun 2018 00:00:00 GMT","draft":false,"meta":{"date":"2018-06-21T00:00:00.000Z","title":"React 16.3 et la nouvelle API Context","author":"neovea","oldSlug":"js/react/react-new-context-api","slug":"react-16-3-et-la-nouvelle-api-context"},"body":"<p>Depuis fin mars 2018, la version 16.3 de React est sortie et a apport√© son lot\nde nouveaut√©s, dont l'API Context. Alors ok, cette API existait d√©j√† par le\npass√© mais il √©tait d√©conseill√© de l'utiliser car sujette √† √©volution (c'est la\ndoc de React qui le disait). Et √©volution il y a eu. La nouvelle API Context est\ndevenue beaucoup plus facile √† utiliser ; sa syntaxe s'est assouplie et\nsimplifi√©e. Ce qui fait d√©sormais d'elle un outil de premier ordre.</p>\n<h2>√Ä quoi √ßa sert exactement ?</h2>\n<p>√áa permet tout simplement de rendre disponibles des propri√©t√©s au sein des ses\ncomposants React sans avoir √† les passer directement √† ces derniers. Autant dire\nque lorsqu'on a une application un peu complexe (entendre beaucoup de composants\net d'h√©ritages de propri√©t√©s), il devient tr√®s vite compliqu√© de maintenir tout\nce petit monde ensemble. De plus, cela pose un souci de performance non\nn√©gligeable √† la longue puisque les donn√©es sont trait√©es par des composants qui\nn'ont rien √† faire avec, sans compter les <code>Render</code>s potentiellement inutiles. Du\ncoup, tr√®s souvent, on a recours √† des solutions qui peuvent se montrer\npotentiellement <em>overkill</em> (aka Redux, Mobx et consorts) afin de s√©gr√©guer tout\nou partie de nos donn√©es pour des composants sp√©cifiques, et les rendre\ndisponibles &quot;facilement&quot; √† l'ensemble de l'app.</p>\n<p>Avec la nouvelle API Context, on peut facilement cr√©er un ou plusieurs <code>store</code>s\npour nos donn√©es. Cela permet de mieux structurer nos donn√©es, mais aussi d'en\npasser la juste quantit√© nos composants, sans avoir √† faire face au calamiteux\n<em><a href=\"https://blog.kentcdodds.com/prop-drilling-bb62e02cb691\">prop drilling</a></em>. Mais\nattention tout de m√™me √† ne pas en faire un marteau dor√©.</p>\n<h2>√Ä quoi √ßa ressemble dans la pratique ?</h2>\n<p>Assez de blabla, passons √† un exemple concret avec des vrais morceaux de\n<code>Context</code> dedans !</p>\n<p>Imaginons que nous souhaitions cr√©er un contexte qui contient les informations\nde l'utilisateur connect√© pour les rendre facilement accessibles √† plusieurs\nendroits de notre app. Nous cr√©ons un contexte et l'impl√©mentons de la mani√®re\nsuivante :</p>\n<h3>Cr√©ation du contexte</h3>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-comment\">// store/UserProvider.js</span>\n<span class=\"hljs-keyword\">import</span> React, { createContext, Component } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;react&quot;</span>; <span class=\"hljs-comment\">// on importe createContext qui servira √† la cr√©ation d&#x27;un ou plusieurs contextes</span>\n\n<span class=\"hljs-comment\">/**\n * `createContext` contient 2 propri√©t√©s :\n * `Provider` et `Consumer`. Nous les rendons accessibles\n * via la constante `UserContext` et on initialise une\n * propri√©t√© par d√©faut &quot;name&quot; qui sera une cha√Æne vide.\n * On exporte ce contexte afin qu&#x27;il soit exploitable par\n * d&#x27;autres composants par la suite via le `Consumer`\n */</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> UserContext = createContext({\n  <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">&quot;&quot;</span>,\n});\n\n<span class=\"hljs-comment\">/**\n * la classe UserProvider fera office de... Provider (!)\n * en englobant son enfant direct\n * dans le composant √©ponyme. De cette fa√ßon, ses values\n * seront accessibles de mani√®re globale via le `Consumer`\n */</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">UserProvider</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Component</span> </span>{\n  state = {\n    <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">&quot;Putain de Code&quot;</span>, <span class=\"hljs-comment\">// une valeur de d√©part</span>\n  };\n\n  <span class=\"hljs-function\"><span class=\"hljs-title\">render</span>(<span class=\"hljs-params\"></span>)</span> {\n    <span class=\"hljs-keyword\">return</span> (\n      <span class=\"hljs-comment\">/**\n       * la propri√©t√© value est tr√®s importante ici, elle rend\n       * le contenu du state disponible aux `Consumers` de l&#x27;application\n       */</span>\n      <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">UserContext.Provider</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">{this.state}</span>&gt;</span>\n        {this.props.children}\n      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">UserContext.Provider</span>&gt;</span></span>\n    );\n  }\n}\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> UserProvider;\n</code></pre>\n<h3>Initialisation du contexte</h3>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-comment\">// app.js</span>\n<span class=\"hljs-keyword\">import</span> React <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;react&quot;</span>;\n<span class=\"hljs-keyword\">import</span> { render } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;react-dom&quot;</span>;\n<span class=\"hljs-keyword\">import</span> Hello <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;./Hello&quot;</span>;\n\n<span class=\"hljs-comment\">// On importe la classe `UserProvider`</span>\n<span class=\"hljs-keyword\">import</span> UserProvider <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;./store/UserProvider&quot;</span>;\n\n<span class=\"hljs-keyword\">const</span> styles = {\n  <span class=\"hljs-attr\">fontFamily</span>: <span class=\"hljs-string\">&quot;sans-serif&quot;</span>,\n  <span class=\"hljs-attr\">textAlign</span>: <span class=\"hljs-string\">&quot;center&quot;</span>,\n};\n\n<span class=\"hljs-keyword\">const</span> App = <span class=\"hljs-function\">() =&gt;</span> (\n  <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">{styles}</span>&gt;</span>\n    {/* A noter qu&#x27;aucune propri√©t√© n&#x27;est pass√©e au composant `Hello` */}\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Hello</span> /&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n);\n\nrender(\n  <span class=\"hljs-comment\">/**\n   * On pourrait tout √† fait n&#x27;englober que les composants qui\n   * nous int√©ressent, mais pour l&#x27;exemple, nous englobons le bootstrap\n   * de notre app dans notre `UserProvider`\n   */</span>\n  <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">UserProvider</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">App</span> /&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">UserProvider</span>&gt;</span></span>,\n  <span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">&quot;root&quot;</span>),\n);\n</code></pre>\n<h3>Cr√©ation du composant <code>Hello</code> qui consommera les data de notre contexte</h3>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-comment\">// Hello.js</span>\n<span class=\"hljs-keyword\">import</span> React <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;react&quot;</span>;\n<span class=\"hljs-comment\">/**\n * On importe cette fois non pas le UserProvider,\n * mais le contexte afin d&#x27;acc√©der au `Consumer`\n */</span>\n<span class=\"hljs-keyword\">import</span> { UserContext } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;./store/UserProvider&quot;</span>;\n\n<span class=\"hljs-comment\">/**\n * Le Consumer expose le contenu de la propri√©t√© `value`\n * du Provider\n */</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> () =&gt; (\n  <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">UserContext.Consumer</span>&gt;</span>\n    {value =&gt; <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span>&gt;</span>Hello {value.name}!<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>}\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">UserContext.Consumer</span>&gt;</span></span>\n);\n</code></pre>\n<h3>Le rendu sera :</h3>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span>&gt;</span>Hello Putain de Code!<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n</code></pre>\n<p>En gros, ce qu'il faut retenir ici, c'est que pour utiliser l'API, on a deux\npropri√©t√©s : le <code>Provider</code>, qui se charge de diffuser nos propri√©t√©s d'une part,\net un ou plusieurs <code>Consumer</code>s qui permettent d'acc√©der aux donn√©es fournies par\nle <code>Provider</code> d'autre part.</p>\n<p>Avec cet exemple minimaliste, on constate qu'il n'est plus n√©cessaire de passer\nles <code>props</code> √† nos composants enfants. Ceci rend le code plus light et plus\nfacile √† lire et √† comprendre. Et √ßa c'est d√©j√† √©norme en soi. Petite note en\npassant : vos composants qui se nourrissent de votre contexte seront re-rendus √†\nchaque fois que ce dernier sera mis √† jour. Donc faites gaffe quand m√™me √† ne\npas en abuser. Mais avec une bonne gestion on peut aller assez loin :)</p>\n<p>Bon c'est bien tout √ßa, mais si on veut permettre √† nos composants de modifier\nles valeurs de notre contexte ?</p>\n<h2>Passer des m√©thodes √† nos composants via <code>Context</code></h2>\n<p>La partie la plus fun commence : on va enrichir notre contexte avec des m√©thodes\nqui seront accessibles aux enfants, et cr√©er un <code>store</code> &quot;√† la Redux&quot; en quelques\nlignes de code seulement ! üòà</p>\n<h3>Impl√©menter une m√©thode</h3>\n<p>On va d√©clarer notre m√©thode √† deux endroits : Dans le <code>context</code>, et dans le\n<code>state</code> de notre <code>UserProvider</code> :</p>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-comment\">// store/UserProvider.js</span>\n...\n\n<span class=\"hljs-comment\">/**\n * On ajoute la propri√©t√© `setName` √† notre contexte\n */</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> UserContext = createContext({\n  <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">&quot;&quot;</span>,\n  <span class=\"hljs-attr\">setName</span>: <span class=\"hljs-function\">() =&gt;</span> {}\n});\n\n...\n\n<span class=\"hljs-comment\">/**\n * et on impl√©mente une m√©thode dans notre `state`\n * qui va mettre √† jour ce dernier avec la valeur pass√©e en param√®tre.\n * A noter qu&#x27;on peut aussi faire appel √† des m√©thodes de notre\n * composant, mais on va faire simple pour l&#x27;exemple.\n */</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">UserProvider</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Component</span> </span>{\n  state = {\n    <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">&quot;Franck&quot;</span>, <span class=\"hljs-comment\">// une valeur de d√©part</span>\n    <span class=\"hljs-attr\">setName</span>: <span class=\"hljs-function\"><span class=\"hljs-params\">name</span> =&gt;</span> <span class=\"hljs-built_in\">this</span>.setState({ <span class=\"hljs-attr\">name</span>: name }) <span class=\"hljs-comment\">// nouvelle propri√©t√© de mutation</span>\n  };\n\n  <span class=\"hljs-function\"><span class=\"hljs-title\">render</span>(<span class=\"hljs-params\"></span>)</span> {\n    <span class=\"hljs-keyword\">return</span> (\n      <span class=\"hljs-comment\">// Ici, rien ne change !</span>\n      <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">UserContext.Provider</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">{this.state}</span>&gt;</span>\n        {this.props.children}\n      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">UserContext.Provider</span>&gt;</span></span>\n    );\n  }\n}\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> UserProvider;\n</code></pre>\n<p>Comme impl√©menter le <code>Consumer</code> dans chaque composant est r√©barbatif, on va\ncr√©er un Higher Order Component qui se chargera d'impl√©menter ce dernier √† notre\nplace :</p>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-comment\">// store/UserProvider.js</span>\n\n...\n\n<span class=\"hljs-comment\">/**\n * A la suite de notre classe `UserProvider`, on cr√©√© notre HOC\n * qui se chargera d&#x27;injecter les propri√©t√©s de notre contexte\n * √† n&#x27;importe quel composant qui l&#x27;appellera\n */</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> withUser = <span class=\"hljs-function\"><span class=\"hljs-params\">Component</span> =&gt;</span> <span class=\"hljs-function\"><span class=\"hljs-params\">props</span> =&gt;</span> (\n  <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">UserContext.Consumer</span>&gt;</span>\n    {store =&gt; <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Component</span> {<span class=\"hljs-attr\">...props</span>} {<span class=\"hljs-attr\">...store</span>} /&gt;</span>}\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">UserContext.Consumer</span>&gt;</span></span>\n)\n</code></pre>\n<p>Il ne reste plus qu'√† modifier notre composant <code>Hello</code> comme suit :</p>\n<pre><code class=\"hljs language-jsx\"><span class=\"hljs-comment\">// Hello.js</span>\n<span class=\"hljs-keyword\">import</span> React, { Fragment } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;react&quot;</span>;\n<span class=\"hljs-comment\">/**\n * On replace `UserContext` par notre HOC `withUser`\n */</span>\n<span class=\"hljs-keyword\">import</span> { withUser } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;./store/UserProvider&quot;</span>;\n\n<span class=\"hljs-comment\">/**\n * et on utilise `withUser` comme n&#x27;importe quel HOC\n * de ce type\n */</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> withUser(<span class=\"hljs-function\">(<span class=\"hljs-params\">{ name, setName }</span>) =&gt;</span> (\n  <span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Fragment</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span>&gt;</span>Hello {name}!<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;text&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">{name}</span> <span class=\"hljs-attr\">onChange</span>=<span class=\"hljs-string\">{e</span> =&gt;</span> setName(e.target.value)} /&gt;\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Fragment</span>&gt;</span></span>\n));\n</code></pre>\n<p>Et tadam ‚ú®‚ú® ! On a cr√©√© un micro store pour notre application !</p>\n<h2>En conclusion</h2>\n<p>Avec l'API Context, les possibilit√©s sont nombreuses, on peut :</p>\n<ul>\n<li>cr√©er des &quot;micro stores&quot; pour certaines parties de notre application, voire\nles faire h√©riter d'un store plus global.</li>\n<li>imaginer combiner les <code>store</code>s et les faire &quot;h√©riter&quot; les uns des autres.</li>\n</ul>\n<p>On r√©sout au passage pas mal de probl√®mes li√©s √† l'imbrication et √† la\nhi√©rarchisation des composants. Ainsi, on peut tr√®s facilement faire face √† une\napplication qui grossit sans avoir √† sortir l'artillerie parfois lourde de\nRedux.</p>\n<p>Maintenant vous avez le pouvoir ! Mais usez-en avec sagesse :)</p>\n<p>Le code source est disponible ici :</p>\n<p><a href=\"https://codesandbox.io/s/mq8jq87v9p\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg\" alt=\"Edit mq8jq87v9p\" /></a></p>\n"}