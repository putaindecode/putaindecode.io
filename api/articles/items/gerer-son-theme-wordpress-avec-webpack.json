{"slug":"gerer-son-theme-wordpress-avec-webpack","filename":"2015-10-20-gerer-son-theme-wordpress-avec-webpack","title":"G√©rer son th√®me WordPress avec Webpack","date":"Tue, 20 Oct 2015 00:00:00 GMT","draft":false,"meta":{"date":"2015-10-20T00:00:00.000Z","title":"G√©rer son th√®me WordPress avec Webpack","author":"MoOx","oldSlug":"wordpress/webpack","slug":"gerer-son-theme-wordpress-avec-webpack"},"body":"<h1>Pourquoi Webpack pour g√©rer son th√®me WordPress ?</h1>\n<p>La r√©ponse est la m√™me qu'√† la simple question\n<a href=\"/fr/articles/js/webpack/\">&quot;pourquoi Webpack ?&quot;</a>. L'int√©r√™t principal est\nd'obtenir des rapports d'erreurs li√©s √† la gestion des assets (images, fonts,\netc).</p>\n<p>Qu'y a-t-il de si particulier √† savoir pour utiliser Webpack pour g√©rer un th√®me\nWordPress ? Pas grand chose, mais voici de quoi vous faire gagner (peut-√™tre) un\npeu de temps.</p>\n<p>Il y a certainement plusieurs fa√ßons de g√©rer son th√®me WordPress avec Webpack.\nCelle que je vous propose va se limiter √† des choses simples en concentrant le\ncode dans le r√©pertoire du th√®me pour plus de modularit√©.</p>\n<p>Pour commencer, deux choses importantes √† savoir :</p>\n<ul>\n<li>Ne mettez pas de CSS dans le fameux <code>style.css</code> √† la racine de votre th√®me,\nlaissez juste le cartouche en commentaire (sans lequel WordPress ne d√©tectera\npas votre th√®me...) ;</li>\n<li>cr√©ez un dossier <code>src</code> dans votre th√®me, o√π nous mettrons nos &quot;sources&quot;, la\npartie du th√®me &quot;compil√©&quot; sera dans un dossier <code>dist</code> et n'aura donc pas\nbesoin d'√™tre versionn√©e.</li>\n</ul>\n<p>La seule petite chose √† laquelle il faut faire attention finalement, c'est de\nbien configurer le <code>publicPath</code> de Webpack afin que les fichiers qu'il g√©n√®re\nsoient bien dans le bon chemin, et que les ressources li√©es (dans les fichiers\nCSS par exemple) comportent les bons chemins relatifs (√† la racine du site).</p>\n<p>Avec l'arborescence suivante, nous n'aurons pas de difficult√© √† faire une\nconfiguration portable :</p>\n<pre><code>- htdocs\n  - wp-content\n    - themes\n      - putaindetheme\n        - node_modules\n        - src\n          - index.js\n          - index.css\n          - images/*\n          - fonts/*\n        - style.css\n        - webpack.config.babel.json\n        - package.json\n- package.json\n</code></pre>\n<p>En plus de cela, nous pouvons ajouter une sorte de raccourci via un\n<code>package.json</code> suppl√©mentaire √† la racine de notre projet :</p>\n<pre><code class=\"hljs language-json\">{\n  <span class=\"hljs-attr\">&quot;private&quot;</span>: <span class=\"hljs-literal\">true</span>,\n  <span class=\"hljs-attr\">&quot;scripts&quot;</span>: {\n    <span class=\"hljs-attr\">&quot;start&quot;</span>: <span class=\"hljs-string\">&quot;cd htdocs/wp-content/themes/putaindetheme &amp;&amp; npm start&quot;</span>,\n    <span class=\"hljs-attr\">&quot;build&quot;</span>: <span class=\"hljs-string\">&quot;cd htdocs/wp-content/themes/putaindetheme &amp;&amp; npm run build&quot;</span>\n  }\n}\n</code></pre>\n<p>Ce petit raccourci nous √©vitera de devoir nous taper en CLI tout le chemin du\nth√®me et nous pourrions m√™me, pourquoi pas, rajouter un\n<code>&quot;prestart&quot;: &quot;open http://yourlocalhost.tld&quot;</code> afin d'ouvrir automatiquement le\nprojet dans le navigateur lorsque nous d√©marrerons notre d√©veloppement via\n<code>$ npm start</code>.</p>\n<p>Voyons rapidement donc le <code>package.json</code> du th√®me ainsi que la config Webpack.</p>\n<p><code>package.json</code></p>\n<pre><code class=\"hljs language-json\">{\n  <span class=\"hljs-attr\">&quot;private&quot;</span>: <span class=\"hljs-literal\">true</span>,\n  <span class=\"hljs-attr\">&quot;scripts&quot;</span>: {\n    <span class=\"hljs-attr\">&quot;start&quot;</span>: <span class=\"hljs-string\">&quot;webpack --config=webpack.config.babel.js --watch&quot;</span>,\n    <span class=\"hljs-attr\">&quot;build&quot;</span>: <span class=\"hljs-string\">&quot;webpack --config=webpack.config.babel.js -p&quot;</span>\n  },\n  <span class=\"hljs-attr\">&quot;devDependencies&quot;</span>: {\n    <span class=\"hljs-attr\">&quot;babel&quot;</span>: <span class=\"hljs-string\">&quot;^5.8.12&quot;</span>,\n    <span class=\"hljs-attr\">&quot;babel-core&quot;</span>: <span class=\"hljs-string\">&quot;^5.8.12&quot;</span>,\n    <span class=\"hljs-attr\">&quot;babel-loader&quot;</span>: <span class=\"hljs-string\">&quot;^5.3.2&quot;</span>,\n    <span class=\"hljs-attr\">&quot;css-loader&quot;</span>: <span class=\"hljs-string\">&quot;^0.15.6&quot;</span>,\n    <span class=\"hljs-attr\">&quot;eslint&quot;</span>: <span class=\"hljs-string\">&quot;^0.24.1&quot;</span>,\n    <span class=\"hljs-attr\">&quot;eslint-loader&quot;</span>: <span class=\"hljs-string\">&quot;^0.14.2&quot;</span>,\n    <span class=\"hljs-attr\">&quot;extract-text-webpack-plugin&quot;</span>: <span class=\"hljs-string\">&quot;^0.8.2&quot;</span>,\n    <span class=\"hljs-attr\">&quot;file-loader&quot;</span>: <span class=\"hljs-string\">&quot;^0.8.4&quot;</span>,\n    <span class=\"hljs-attr\">&quot;json-loader&quot;</span>: <span class=\"hljs-string\">&quot;^0.5.2&quot;</span>,\n    <span class=\"hljs-attr\">&quot;postcss-cssnext&quot;</span>: <span class=\"hljs-string\">&quot;^2.1.0&quot;</span>,\n    <span class=\"hljs-attr\">&quot;postcss-import&quot;</span>: <span class=\"hljs-string\">&quot;^7.0.0&quot;</span>,\n    <span class=\"hljs-attr\">&quot;postcss-loader&quot;</span>: <span class=\"hljs-string\">&quot;^0.6.0&quot;</span>,\n    <span class=\"hljs-attr\">&quot;postcss-url&quot;</span>: <span class=\"hljs-string\">&quot;^5.0.2&quot;</span>,\n    <span class=\"hljs-attr\">&quot;style-loader&quot;</span>: <span class=\"hljs-string\">&quot;^0.12.3&quot;</span>,\n    <span class=\"hljs-attr\">&quot;webpack&quot;</span>: <span class=\"hljs-string\">&quot;^1.10.5&quot;</span>\n  },\n  <span class=\"hljs-attr\">&quot;dependencies&quot;</span>: {\n    <span class=\"hljs-attr\">&quot;normalize.css&quot;</span>: <span class=\"hljs-string\">&quot;^3.0.3&quot;</span>\n  }\n}\n</code></pre>\n<p>Quelques petites notes sur ce contenu :</p>\n<ul>\n<li><code>private</code> sert √† √©viter la publication de votre &quot;paquet&quot; sur npm, ainsi qu'√†\ndevoir remplir certains champs tels que <code>name</code> et compagnie ;</li>\n<li>nous mettrons dans <code>devDependencies</code> les d√©pendances pour le d√©veloppement et\ndans <code>dependencies</code> les d√©pendances qui seront dans le build final. Ici, j'ai\nsimplement mis <code>normalize.css</code> pour exemple, mais vous pourriez tr√®s bien\navoir aussi jQuery (:trollface:) ou React ;</li>\n<li>les scripts utilisent <code>webpack.config.babel.js</code> afin de pouvoir d√©finir la\nconfiguration en es6/7 via <em>babel</em>.</li>\n</ul>\n<p>Voyons maintenant la config <code>webpack.config.babel.js</code> :</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// Note: le code ci-dessous est mal rendu</span>\n<span class=\"hljs-comment\">// Une issue est ouverte √† ce propos</span>\n<span class=\"hljs-comment\">// https://github.com/isagalaev/highlight.js/issues/958</span>\n\n<span class=\"hljs-keyword\">import</span> <span class=\"hljs-string\">&quot;babel/polyfill&quot;</span>;\n<span class=\"hljs-keyword\">import</span> path <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;path&quot;</span>;\n<span class=\"hljs-keyword\">import</span> ExtractTextPlugin <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;extract-text-webpack-plugin&quot;</span>;\n<span class=\"hljs-keyword\">import</span> postcssImport <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;postcss-import&quot;</span>;\n<span class=\"hljs-keyword\">import</span> postcssUrl <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;postcss-url&quot;</span>;\n<span class=\"hljs-keyword\">import</span> postcssCssnext <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;postcss-cssnext&quot;</span>;\n\n<span class=\"hljs-keyword\">const</span> production = process.argv.includes(<span class=\"hljs-string\">`-p`</span>);\n\n<span class=\"hljs-keyword\">const</span> theme = path.basename(__dirname);\n<span class=\"hljs-keyword\">const</span> src = path.join(__dirname, <span class=\"hljs-string\">`src`</span>);\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n  <span class=\"hljs-attr\">entry</span>: {\n    <span class=\"hljs-attr\">index</span>: [<span class=\"hljs-string\">`<span class=\"hljs-subst\">${src}</span>/index.js`</span>],\n  },\n\n  <span class=\"hljs-attr\">output</span>: {\n    <span class=\"hljs-attr\">path</span>: path.join(__dirname, <span class=\"hljs-string\">`dist`</span>),\n    <span class=\"hljs-attr\">filename</span>: <span class=\"hljs-string\">`[name].js`</span>,\n    <span class=\"hljs-attr\">publicPath</span>: <span class=\"hljs-string\">`wp-content/themes/<span class=\"hljs-subst\">${theme}</span>/dist/`</span>,\n  },\n  <span class=\"hljs-attr\">resolve</span>: {\n    <span class=\"hljs-attr\">extensions</span>: [<span class=\"hljs-string\">``</span>, <span class=\"hljs-string\">`.js`</span>, <span class=\"hljs-string\">`.json`</span>],\n  },\n\n  <span class=\"hljs-attr\">module</span>: {\n    <span class=\"hljs-attr\">loaders</span>: [\n      {\n        <span class=\"hljs-attr\">test</span>: <span class=\"hljs-regexp\">/\\.json$/</span>,\n        loader: <span class=\"hljs-string\">`json-loader`</span>,\n      },\n      {\n        <span class=\"hljs-attr\">test</span>: <span class=\"hljs-regexp\">/\\.js$/</span>,\n        loaders: [<span class=\"hljs-string\">`babel-loader`</span>, <span class=\"hljs-string\">`eslint-loader`</span>],\n        <span class=\"hljs-attr\">include</span>: src,\n      },\n      {\n        <span class=\"hljs-attr\">test</span>: <span class=\"hljs-regexp\">/\\.css$/</span>,\n        loader: ExtractTextPlugin.extract(\n          <span class=\"hljs-string\">`style-loader`</span>,\n          [<span class=\"hljs-string\">`css-loader`</span>, <span class=\"hljs-string\">`postcss-loader`</span>].join(<span class=\"hljs-string\">`!`</span>),\n        ),\n      },\n      {\n        <span class=\"hljs-attr\">test</span>: <span class=\"hljs-regexp\">/\\.(ico|jpe?g|png|gif)$/</span>,\n        loader: <span class=\"hljs-string\">`file-loader?name=[path][name].[ext]&amp;context=<span class=\"hljs-subst\">${src}</span>/`</span>,\n      },\n    ],\n  },\n\n  <span class=\"hljs-attr\">plugins</span>: [<span class=\"hljs-keyword\">new</span> ExtractTextPlugin(<span class=\"hljs-string\">`[name].css`</span>, { <span class=\"hljs-attr\">disable</span>: !production })],\n\n  <span class=\"hljs-attr\">postcss</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>{\n    <span class=\"hljs-comment\">// https://github.com/postcss/postcss-loader/issues/31</span>\n    <span class=\"hljs-keyword\">const</span> webpack = <span class=\"hljs-built_in\">this</span>;\n\n    <span class=\"hljs-keyword\">return</span> [\n      postcssImport({\n        <span class=\"hljs-attr\">onImport</span>: <span class=\"hljs-function\"><span class=\"hljs-params\">files</span> =&gt;</span> files.forEach(webpack.addDependency),\n      }),\n      postcssUrl(),\n      postcssCssnext({\n        <span class=\"hljs-attr\">browsers</span>: <span class=\"hljs-string\">`last 2 versions`</span>,\n      }),\n    ];\n  },\n};\n</code></pre>\n<p><em>Bien entendu, libre √† vous d'adapter les loaders Webpack √† utiliser, ainsi que\nla configuration PostCSS par exemple.</em> Faites un tour sur notre article de\n<a href=\"/fr/articles/js/webpack/premier-exemple/\">premier exemple de configuration Webpack</a>\nafin d'y voir plus clair.</p>\n<p>Il nous reste maintenant √† ajouter dans notre th√®me WordPress les r√©f√©rences √†\nnos points d'entr√©es CSS et JavaScript que sont <code>index.css</code> et <code>index.js</code>.</p>\n<p>Pour faire simplement, dans votre fichier <code>functions.php</code> (oui, le fichier qui a\nun nom qui n'indique pas du tout ce pour quoi tout le monde se sert du fichier,\nc'est √† dire la configuration du th√®me au runtime...), on va ajouter une petite\nconstante qui servira √† adapter votre th√®me en fonction de l'environnement :</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-comment\">// ENV est √† d√©finir dans votre configuration Apache par exemple.</span>\n<span class=\"hljs-comment\">// Si vous ne voulez pas y toucher, vous pouvez plut√¥t d√©finir d&#x27;une autre fa√ßon</span>\n<span class=\"hljs-comment\">// en testant le SERVER_NAME par exemple</span>\ndefine(<span class=\"hljs-string\">&#x27;ENV&#x27;</span>, getenv(<span class=\"hljs-string\">&#x27;ENV&#x27;</span>));\n\n<span class=\"hljs-comment\">// en local, on pourrait d√©finir ENV √† &quot;development&quot;</span>\n</code></pre>\n<p>_Nous pourrions dans ce fichier utiliser l'API de Wordpress pour enregister nos\n<code>index.css</code> et <code>index.js</code> via les m√©thodes <code>wp_(de)register*</code>, mais nous\nresterons simples pour l'exemple.*</p>\n<p>Vu qu'on utilise le <code>style-loader</code> de Webpack en d√©veloppement, on ne va ajouter\nnotre feuille de style qu'en production (dans le <code>&lt;head&gt;</code>).</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">if</span> (ENV != <span class=\"hljs-string\">&quot;development&quot;</span>): <span class=\"hljs-meta\">?&gt;</span>\n  &lt;link rel=<span class=\"hljs-string\">&quot;stylesheet&quot;</span> href=<span class=\"hljs-string\">&quot;&lt;?php echo get_bloginfo(&#x27;template_directory&#x27;) ?&gt;/dist/index.css&quot;</span> /&gt;\n<span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">endif</span>; <span class=\"hljs-meta\">?&gt;</span>\n</code></pre>\n<p>Pensez aussi √† supprimer la r√©f√©rence √† <code>style.css</code> dans <code>header.php</code>.</p>\n<p>Dans la m√™me id√©e mais en plus simple, on va ajouter dans notre <code>footer.php</code>.</p>\n<pre><code class=\"hljs language-php\">&lt;script src=<span class=\"hljs-string\">&quot;&lt;?php echo get_bloginfo(&#x27;template_directory&#x27;) ?&gt;/dist/index.js&quot;</span>&gt;&lt;/script&gt;\n</code></pre>\n<p>Rien de bien compliqu√© finalement.</p>\n<p><em>Attention si votre th√®me h√©rite d'un autre,\n<code>get_bloginfo('template_directory')</code> ne pointera pas vers votre th√®me mais le\nth√®me parent. Il vous faudra donc ajuster le code üòë.</em></p>\n<hr />\n<p>Pour le test vous pouvez mettre dans les CSS et JS :</p>\n<p><code>index.css</code></p>\n<pre><code class=\"hljs language-css\"><span class=\"hljs-keyword\">@import</span> <span class=\"hljs-string\">&quot;normalize.css&quot;</span>;\n<span class=\"hljs-selector-tag\">body</span> {\n  <span class=\"hljs-attribute\">background</span>: red;\n}\n</code></pre>\n<p>Notez ici que par la fa√ßon dont nous avons d√©fini Webpack ci-dessus, vous\ndevriez placer et r√©f√©rencer vos assets (images &amp; co), depuis <code>src</code>. Exemple :</p>\n<pre><code class=\"hljs language-css\"><span class=\"hljs-selector-tag\">html</span> {\n  <span class=\"hljs-attribute\">background</span>: <span class=\"hljs-built_in\">url</span>(./images/background.jpg);\n  <span class=\"hljs-comment\">/* =&gt; wp-content/themes/putaindetheme/src/images/background.jpg */</span>\n}\n</code></pre>\n<p>Ensuite, dans <code>index.js</code>, je vous laisse vous d√©brouiller :)</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">&quot;Hey !&quot;</span>);\n</code></pre>\n<p>Libre √† vous maintenant d'ajouter vos d√©pendances favorites et de remplir vos\n<code>index.css</code> et <code>index.js</code> avec une gestion d'erreurs autre que des requ√™tes HTTP\nen 404 !</p>\n"}